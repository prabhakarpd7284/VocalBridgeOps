// VocalBridge Ops - Database Schema
// Multi-tenant AI Agent Gateway

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// TENANT & AUTHENTICATION
// ============================================================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  apiKeys     ApiKey[]
  agents      Agent[]
  sessions    Session[]
  usageEvents UsageEvent[]
  jobs        Job[]

  @@map("tenants")
}

model ApiKey {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Key data
  keyPrefix String      // First 12 chars for identification (e.g., "vb_live_abc1")
  keyHash   String   @unique
  name      String?     // Optional label (e.g., "Production Key")

  // RBAC
  role      TenantRole @default(ADMIN)

  // Lifecycle
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?
  revokedAt  DateTime?
  lastUsedAt DateTime?

  @@index([tenantId])
  @@index([keyHash])
  @@map("api_keys")
}

enum TenantRole {
  ADMIN
  ANALYST
}

// ============================================================================
// AGENTS
// ============================================================================

model Agent {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Basic info
  name        String
  description String?

  // Provider configuration
  primaryProvider  ProviderType
  fallbackProvider ProviderType?

  // AI configuration
  systemPrompt String
  temperature  Float  @default(0.7)
  maxTokens    Int    @default(1024)

  // Tools (JSON array of tool names)
  enabledTools Json   @default("[]")

  // Voice configuration
  voiceEnabled Boolean @default(false)
  voiceConfig  Json?   // { sttProvider, ttsProvider, voice }

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessions Session[]

  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("agents")
}

enum ProviderType {
  VENDOR_A
  VENDOR_B
}

// ============================================================================
// SESSIONS & MESSAGES
// ============================================================================

model Session {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agentId    String
  agent      Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Customer reference
  customerId String

  // Channel and status
  channel    ChannelType   @default(CHAT)
  status     SessionStatus @default(ACTIVE)

  // Demo mode (no billing)
  demoMode   Boolean       @default(false)

  // Arbitrary metadata
  metadata   Json?

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  endedAt   DateTime?

  // Relations
  messages       Message[]
  providerCalls  ProviderCall[]
  usageEvents    UsageEvent[]
  audioArtifacts AudioArtifact[]

  @@index([tenantId])
  @@index([tenantId, agentId])
  @@index([tenantId, customerId])
  @@index([tenantId, createdAt])
  @@map("sessions")
}

enum ChannelType {
  CHAT
  VOICE
}

enum SessionStatus {
  ACTIVE
  ENDED
  ERROR
}

model Message {
  id             String   @id @default(uuid())
  sessionId      String
  session        Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Ordering within session
  sequenceNumber Int

  // Idempotency
  idempotencyKey String?

  // Content
  role    MessageRole
  content String

  // Tool calls (JSON array)
  toolCalls Json?

  // Voice reference
  audioArtifactId String?
  audioArtifact   AudioArtifact? @relation(fields: [audioArtifactId], references: [id])

  // Provider call reference (for assistant messages)
  providerCallId String?
  providerCall   ProviderCall? @relation(fields: [providerCallId], references: [id])

  // Timestamp
  createdAt DateTime @default(now())

  @@unique([sessionId, idempotencyKey])
  @@unique([sessionId, sequenceNumber])
  @@index([sessionId])
  @@index([sessionId, createdAt])
  // NEW: Performance indexes
  @@index([idempotencyKey], name: "idx_messages_idempotency")
  @@index([sessionId, role, createdAt], name: "idx_messages_conversation")
  @@map("messages")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
}

// ============================================================================
// PROVIDER CALLS
// ============================================================================

model ProviderCall {
  id            String   @id @default(uuid())
  sessionId     String
  session       Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Tracing
  correlationId String

  // Provider info
  provider   ProviderType
  isFallback Boolean @default(false)

  // Request/Response (for debugging)
  requestBody  Json?
  responseBody Json?

  // Metrics
  tokensIn  Int
  tokensOut Int
  latencyMs Int

  // Status
  status       ProviderCallStatus
  errorCode    String?
  errorMessage String?

  // Retry tracking
  attemptNumber Int @default(1)

  // Billing flag
  billed Boolean @default(false)

  // Timestamp
  createdAt DateTime @default(now())

  // Relations
  messages   Message[]
  usageEvent UsageEvent?

  @@index([sessionId])
  @@index([correlationId])
  @@index([createdAt])
  // NEW: Performance indexes for billing and analytics
  @@index([billed, createdAt], name: "idx_provider_calls_billing")
  @@index([status, createdAt], name: "idx_provider_calls_status")
  @@index([sessionId, createdAt], name: "idx_provider_calls_session_time")
  @@index([provider, status, createdAt], name: "idx_provider_calls_analytics")
  @@map("provider_calls")
}

enum ProviderCallStatus {
  SUCCESS
  FAILED
  TIMEOUT
  RATE_LIMITED
}

// ============================================================================
// USAGE & BILLING
// ============================================================================

model UsageEvent {
  id             String   @id @default(uuid())
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agentId        String
  sessionId      String
  session        Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Provider call reference
  providerCallId String       @unique
  providerCall   ProviderCall @relation(fields: [providerCallId], references: [id])

  // Provider
  provider ProviderType

  // Token counts
  tokensIn    Int
  tokensOut   Int
  totalTokens Int

  // Cost in cents (integer for precision)
  costCents Int

  // Pricing snapshot for audit
  pricingSnapshot Json

  // Timestamp
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, agentId])
  @@index([tenantId, createdAt])
  @@index([tenantId, agentId, createdAt])
  // NEW: Performance indexes for provider analytics
  @@index([provider, createdAt], name: "idx_usage_events_provider")
  @@index([tenantId, provider, createdAt], name: "idx_usage_events_tenant_provider")
  @@map("usage_events")
}

// ============================================================================
// ASYNC JOBS
// ============================================================================

model Job {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Job type
  type JobType

  // Idempotency
  idempotencyKey String?

  // Input/Output
  input  Json
  output Json?

  // Status
  status   JobStatus @default(PENDING)
  progress Int       @default(0)

  // Error info
  errorMessage String?

  // Callback
  callbackUrl  String?
  callbackSent Boolean @default(false)

  // Locking for worker
  lockedAt      DateTime?
  lockedBy      String?
  lockExpiresAt DateTime?

  // Retry tracking
  attempts    Int @default(0)
  maxAttempts Int @default(3)
  lastError   String?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?

  @@unique([tenantId, idempotencyKey])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([status, lockExpiresAt])
  @@map("jobs")
}

enum JobType {
  SEND_MESSAGE
  VOICE_PROCESS
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================================================
// TOOL EXECUTIONS
// ============================================================================

model ToolExecution {
  id            String @id @default(uuid())

  // Context
  sessionId     String
  messageId     String
  correlationId String

  // Tool info
  toolName  String
  toolInput Json
  toolOutput Json?

  // Status
  status       ToolExecutionStatus
  errorMessage String?

  // Metrics
  latencyMs Int
  costCents Int @default(0)

  // Timestamp
  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([correlationId])
  @@index([toolName, createdAt])
  @@map("tool_executions")
}

enum ToolExecutionStatus {
  SUCCESS
  FAILED
  TIMEOUT
}

// ============================================================================
// VOICE / AUDIO
// ============================================================================

model AudioArtifact {
  id        String  @id @default(uuid())
  sessionId String
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Type
  type AudioType

  // Storage
  filePath String?
  fileSize Int?

  // Metadata
  durationMs Int?
  format     String?
  sampleRate Int?

  // Processing info
  provider   String?
  transcript String?
  latencyMs  Int?

  // Timestamp
  createdAt DateTime @default(now())

  // Relations
  messages Message[]

  @@index([sessionId])
  @@map("audio_artifacts")
}

enum AudioType {
  USER_INPUT
  ASSISTANT_OUTPUT
}
