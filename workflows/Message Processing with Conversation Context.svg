<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="2994px" preserveAspectRatio="none" style="width:1527px;height:2994px;background:#FEFEFE;" version="1.1" viewBox="0 0 1527 2994" width="1527px" zoomAndPan="magnify"><title>Complete Message Processing Flow - VocalBridge Ops</title><defs/><g><rect fill="#FEFEFE" height="2994" style="stroke:none;stroke-width:1;" width="1527" x="0" y="0"/><text fill="#000000" font-family="Verdana" font-size="22" font-weight="bold" lengthAdjust="spacing" textLength="666.0371" x="429.095" y="37.1182">Complete Message Processing Flow - VocalBridge Ops</text><rect fill="#FFFFFF" height="2367.4717" style="stroke:#000000;stroke-width:1;" width="1495.2271" x="15" y="314.3472"/><rect fill="#FFFFFF" height="2274.2744" style="stroke:none;stroke-width:1;" width="1495.2271" x="15" y="407.5444"/><rect fill="#FFFFFF" height="152.7959" style="stroke:#000000;stroke-width:1;" width="498.7471" x="783.8154" y="1552.6816"/><rect fill="#FFFFFF" height="226.7632" style="stroke:#000000;stroke-width:1;" width="813.5815" x="686.6455" y="2126.2666"/><rect fill="#FFFFFF" height="87.9673" style="stroke:none;stroke-width:1;" width="813.5815" x="686.6455" y="2265.0625"/><g><title>User</title><rect fill="#000000" fill-opacity="0.00000" height="2781.8594" width="8" x="39.9277" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="43" x2="43" y1="130.752" y2="2912.6113"/></g><g><title>Message Service</title><rect fill="#000000" fill-opacity="0.00000" height="2781.8594" width="8" x="371.1162" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="374.7339" x2="374.7339" y1="130.752" y2="2912.6113"/></g><g><title>PostgreSQL</title><rect fill="#000000" fill-opacity="0.00000" height="2781.8594" width="8" x="736.2305" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="739.6455" x2="739.6455" y1="130.752" y2="2912.6113"/></g><g><title>Provider</title><rect fill="#000000" fill-opacity="0.00000" height="2781.8594" width="8" x="851.1499" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="854.8154" x2="854.8154" y1="130.752" y2="2912.6113"/></g><g><title>AI Provider</title><rect fill="#000000" fill-opacity="0.00000" height="2781.8594" width="8" x="1076.2373" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="1080.0059" x2="1080.0059" y1="130.752" y2="2912.6113"/></g><g><title>Tool Registry</title><rect fill="#000000" fill-opacity="0.00000" height="2781.8594" width="8" x="1205.5156" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="1209.4688" x2="1209.4688" y1="130.752" y2="2912.6113"/></g><g><title>Billing Service</title><rect fill="#000000" fill-opacity="0.00000" height="2781.8594" width="8" x="1345.1196" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="1348.5625" x2="1348.5625" y1="130.752" y2="2912.6113"/></g><g class="participant participant-head" data-participant="User"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="31.8555" x="25" y="127.8125">User</text><ellipse cx="43.9277" cy="61.7373" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1;"/><path d="M43.9277,69.7373 L43.9277,96.7373 M30.9277,77.7373 L56.9277,77.7373 M43.9277,96.7373 L30.9277,111.7373 M43.9277,96.7373 L56.9277,111.7373" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-tail" data-participant="User"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="31.8555" x="25" y="2925.6865">User</text><ellipse cx="43.9277" cy="2937.626" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1;"/><path d="M43.9277,2945.626 L43.9277,2972.626 M30.9277,2953.626 L56.9277,2953.626 M43.9277,2972.626 L30.9277,2987.626 M43.9277,2972.626 L56.9277,2987.626" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-head" data-participant="MS"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="130.7646" x="309.7339" y="98.7373"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="116.7646" x="316.7339" y="119.8125">Message Service</text></g><g class="participant participant-tail" data-participant="MS"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="130.7646" x="309.7339" y="2911.6113"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="116.7646" x="316.7339" y="2932.6865">Message Service</text></g><g class="participant participant-head" data-participant="DB"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="81.1699" x="696.6455" y="127.8125">PostgreSQL</text><path d="M722.2305,77.7373 C722.2305,67.7373 740.2305,67.7373 740.2305,67.7373 C740.2305,67.7373 758.2305,67.7373 758.2305,77.7373 L758.2305,103.7373 C758.2305,113.7373 740.2305,113.7373 740.2305,113.7373 C740.2305,113.7373 722.2305,113.7373 722.2305,103.7373 L722.2305,77.7373" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M722.2305,77.7373 C722.2305,87.7373 740.2305,87.7373 740.2305,87.7373 C740.2305,87.7373 758.2305,87.7373 758.2305,77.7373" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-tail" data-participant="DB"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="81.1699" x="696.6455" y="2925.6865">PostgreSQL</text><path d="M722.2305,2938.626 C722.2305,2928.626 740.2305,2928.626 740.2305,2928.626 C740.2305,2928.626 758.2305,2928.626 758.2305,2938.626 L758.2305,2964.626 C758.2305,2974.626 740.2305,2974.626 740.2305,2974.626 C740.2305,2974.626 722.2305,2974.626 722.2305,2964.626 L722.2305,2938.626" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M722.2305,2938.626 C722.2305,2948.626 740.2305,2948.626 740.2305,2948.626 C740.2305,2948.626 758.2305,2948.626 758.2305,2938.626" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-head" data-participant="PO"><rect fill="#FFFFFF" height="48.0293" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="102.6689" x="803.8154" y="81.7227"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="58.0781" x="826.1108" y="102.7979">Provider</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="88.6689" x="810.8154" y="119.8125">Orchestrator</text></g><g class="participant participant-tail" data-participant="PO"><rect fill="#FFFFFF" height="48.0293" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="102.6689" x="803.8154" y="2911.6113"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="58.0781" x="826.1108" y="2932.6865">Provider</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="88.6689" x="810.8154" y="2949.7012">Orchestrator</text></g><g class="participant participant-head" data-participant="AI"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="92.4629" x="1034.0059" y="98.7373"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="78.4629" x="1041.0059" y="119.8125">AI Provider</text></g><g class="participant participant-tail" data-participant="AI"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="92.4629" x="1034.0059" y="2911.6113"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="78.4629" x="1041.0059" y="2932.6865">AI Provider</text></g><g class="participant participant-head" data-participant="TR"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="106.0938" x="1156.4688" y="98.7373"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="92.0938" x="1163.4688" y="119.8125">Tool Registry</text></g><g class="participant participant-tail" data-participant="TR"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="106.0938" x="1156.4688" y="2911.6113"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="92.0938" x="1163.4688" y="2932.6865">Tool Registry</text></g><g class="participant participant-head" data-participant="BS"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="113.1143" x="1292.5625" y="98.7373"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="99.1143" x="1299.5625" y="119.8125">Billing Service</text></g><g class="participant participant-tail" data-participant="BS"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="113.1143" x="1292.5625" y="2911.6113"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="99.1143" x="1299.5625" y="2932.6865">Billing Service</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1515.2271" x="5" y="161.6516"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="161.6516" y2="161.6516"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="164.6516" y2="164.6516"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="235.4697" x="644.8787" y="150.752"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="217.0264" x="650.8787" y="167.8218">Step 1: Validate Idempotency</text><g class="message" data-participant-1="User" data-participant-2="MS"><polygon fill="#000000" points="363.1162,233.9492,373.1162,237.9492,363.1162,241.9492,367.1162,237.9492" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="43.9277" x2="369.1162" y1="237.9492" y2="237.9492"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="193.6987" x="50.9277" y="201.6211">POST /sessions/:id/messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="270.6006" x="50.9277" y="217.4204">X-Idempotency-Key: msg_unique_12345</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="260.019" x="50.9277" y="233.2197">{"content": "What's my order status?"}</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="728.2305,295.3472,738.2305,299.3472,728.2305,303.3472,732.2305,299.3472" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="375.1162" x2="734.2305" y1="299.3472" y2="299.3472"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="173.6846" x="382.1162" y="263.019">SELECT * FROM messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="140.8608" x="382.1162" y="278.8184">WHERE sessionId = ?</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="168.1177" x="382.1162" y="294.6177">AND idempotencyKey = ?</text></g><path d="M15,314.3472 L79.0493,314.3472 L79.0493,322.1465 L69.0493,332.1465 L15,332.1465 L15,314.3472" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><rect fill="none" height="2367.4717" style="stroke:#000000;stroke-width:1;" width="1495.2271" x="15" y="314.3472"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19.0493" x="30" y="328.417">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="155.1655" x="94.0493" y="327.4063">[Message already exists]</text><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="386.1162,349.9458,376.1162,353.9458,386.1162,357.9458,382.1162,353.9458" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="380.1162" x2="739.2305" y1="353.9458" y2="353.9458"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="157.4346" x="392.1162" y="349.2163">Found existing message</text></g><g class="message" data-participant-1="MS" data-participant-2="User"><polygon fill="#000000" points="54.9277,395.5444,44.9277,399.5444,54.9277,403.5444,50.9277,399.5444" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="48.9277" x2="374.1162" y1="399.5444" y2="399.5444"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="157.2695" x="60.9277" y="379.0156">Return cached response</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="60.4106" x="60.9277" y="394.8149">(200 OK)</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="15" x2="1510.2271" y1="408.5444" y2="408.5444"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="97.4478" x="20" y="419.6035">[New message]</text><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="386.1162,440.7124,376.1162,444.7124,386.1162,448.7124,382.1162,444.7124" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="380.1162" x2="739.2305" y1="444.7124" y2="444.7124"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="64.3208" x="392.1162" y="439.9829">Not found</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1515.2271" x="5" y="473.6121"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="473.6121" y2="473.6121"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="476.6121" y2="476.6121"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="228.7031" x="648.262" y="462.7124"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="210.2598" x="654.262" y="479.7822">Step 2: Acquire Session Lock</text><g class="message" data-participant-1="MS" data-participant-2="MS"><line style="stroke:#000000;stroke-width:1;" x1="375.1162" x2="417.1162" y1="534.1104" y2="534.1104"/><line style="stroke:#000000;stroke-width:1;" x1="417.1162" x2="417.1162" y1="534.1104" y2="547.1104"/><line style="stroke:#000000;stroke-width:1;" x1="376.1162" x2="417.1162" y1="547.1104" y2="547.1104"/><polygon fill="#000000" points="386.1162,543.1104,376.1162,547.1104,386.1162,551.1104,382.1162,547.1104" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="131.6567" x="382.1162" y="513.5815">Acquire session lock</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="217.4707" x="382.1162" y="529.3809">(prevents concurrent processing)</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1515.2271" x="5" y="576.01"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="576.01" y2="576.01"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="579.01" y2="579.01"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="170.876" x="677.1755" y="565.1104"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="152.4326" x="683.1755" y="582.1802">Step 3: Load Context</text><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="728.2305,632.5083,738.2305,636.5083,728.2305,640.5083,732.2305,636.5083" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="375.1162" x2="734.2305" y1="636.5083" y2="636.5083"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="163.8457" x="382.1162" y="615.9795">SELECT * FROM sessions</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="91.2095" x="382.1162" y="631.7788">WHERE id = ?</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="386.1162,662.3076,376.1162,666.3076,386.1162,670.3076,382.1162,666.3076" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="380.1162" x2="739.2305" y1="666.3076" y2="666.3076"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="265.5225" x="392.1162" y="661.5781">Session (tenantId, agentId, customerId)</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="728.2305,707.9063,738.2305,711.9063,728.2305,715.9063,732.2305,711.9063" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="375.1162" x2="734.2305" y1="711.9063" y2="711.9063"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="153.0991" x="382.1162" y="691.3774">SELECT * FROM agents</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="91.2095" x="382.1162" y="707.1768">WHERE id = ?</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="386.1162,753.5049,376.1162,757.5049,386.1162,761.5049,382.1162,757.5049" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="380.1162" x2="739.2305" y1="757.5049" y2="757.5049"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="237.8276" x="392.1162" y="736.9761">Agent (systemPrompt, temperature,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="175.1064" x="392.1162" y="752.7754">maxTokens, enabledTools)</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="728.2305,830.7021,738.2305,834.7021,728.2305,838.7021,732.2305,834.7021" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="375.1162" x2="734.2305" y1="834.7021" y2="834.7021"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="173.6846" x="382.1162" y="782.5747">SELECT * FROM messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="140.8608" x="382.1162" y="798.374">WHERE sessionId = ?</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="185.9165" x="382.1162" y="814.1733">ORDER BY sequenceNumber</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="58.2461" x="382.1162" y="829.9727">LIMIT 50</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="386.1162,892.1001,376.1162,896.1001,386.1162,900.1001,382.1162,896.1001" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="380.1162" x2="739.2305" y1="896.1001" y2="896.1001"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="134.9575" x="392.1162" y="859.772">Conversation history</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="196.7329" x="392.1162" y="875.5713">[{role: "user", content: "Hi"},</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="246.0034" x="396.6865" y="891.3706">{role: "assistant", content: "Hello!"}]</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1515.2271" x="5" y="924.9998"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="924.9998" y2="924.9998"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="927.9998" y2="927.9998"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="242.1221" x="641.5525" y="914.1001"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="223.6787" x="647.5525" y="931.1699">Step 4: Build Provider Request</text><g class="message" data-participant-1="MS" data-participant-2="MS"><line style="stroke:#000000;stroke-width:1;" x1="375.1162" x2="417.1162" y1="1143.4912" y2="1143.4912"/><line style="stroke:#000000;stroke-width:1;" x1="417.1162" x2="417.1162" y1="1143.4912" y2="1156.4912"/><line style="stroke:#000000;stroke-width:1;" x1="376.1162" x2="417.1162" y1="1156.4912" y2="1156.4912"/><polygon fill="#000000" points="386.1162,1152.4912,376.1162,1156.4912,386.1162,1160.4912,382.1162,1156.4912" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="259.2954" x="382.1162" y="964.9692">Build ProviderRequest with full context:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="382.1162" y="980.7686">{</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="308.4961" x="391.2568" y="996.5679">systemPrompt: "You are a helpful assistant...",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="80.7358" x="391.2568" y="1012.3672">messages: [</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="190.8296" x="400.3975" y="1028.1665">{role: "user", content: "Hi"},</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="244.8291" x="400.3975" y="1043.9658">{role: "assistant", content: "Hello!"},</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="332.833" x="400.3975" y="1059.7651">{role: "user", content: "What's my order status?"}</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="10.6323" x="391.2568" y="1075.5645">],</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="122.7446" x="391.2568" y="1091.3638">maxTokens: 1024,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="117.8125" x="391.2568" y="1107.1631">temperature: 0.7,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="210.4248" x="391.2568" y="1122.9624">tools: [InvoiceLookupDefinition]</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="382.1162" y="1138.7617">}</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1515.2271" x="5" y="1185.3909"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="1185.3909" y2="1185.3909"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="1188.3909" y2="1188.3909"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="218.896" x="653.1655" y="1174.4912"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="200.4526" x="659.1655" y="1191.561">Step 5: Store User Message</text><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="728.2305,1241.8892,738.2305,1245.8892,728.2305,1249.8892,732.2305,1245.8892" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="375.1162" x2="734.2305" y1="1245.8892" y2="1245.8892"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="177.2646" x="382.1162" y="1225.3604">Get next sequence number</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="112.7852" x="382.1162" y="1241.1597">(atomic function)</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="386.1162,1271.6885,376.1162,1275.6885,386.1162,1279.6885,382.1162,1275.6885" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="380.1162" x2="739.2305" y1="1275.6885" y2="1275.6885"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="141.3623" x="392.1162" y="1270.959">sequenceNumber = 3</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="728.2305,1333.0864,738.2305,1337.0864,728.2305,1341.0864,732.2305,1337.0864" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="375.1162" x2="734.2305" y1="1337.0864" y2="1337.0864"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="156.292" x="382.1162" y="1300.7583">INSERT INTO messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="189.2998" x="382.1162" y="1316.5576">(sessionId, idempotencyKey,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="211.6753" x="382.1162" y="1332.3569">role, content, sequenceNumber)</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="386.1162,1362.8857,376.1162,1366.8857,386.1162,1370.8857,382.1162,1366.8857" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="380.1162" x2="739.2305" y1="1366.8857" y2="1366.8857"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="137.4839" x="392.1162" y="1362.1563">User message stored</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1515.2271" x="5" y="1395.7854"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="1395.7854" y2="1395.7854"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="1398.7854" y2="1398.7854"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="168.0957" x="678.5657" y="1384.8857"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="149.6523" x="684.5657" y="1401.9556">Step 6: Call Provider</text><g class="message" data-participant-1="MS" data-participant-2="PO"><polygon fill="#000000" points="843.1499,1447.384,853.1499,1451.384,843.1499,1455.384,847.1499,1451.384" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="375.1162" x2="849.1499" y1="1451.384" y2="1451.384"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="205.4863" x="382.1162" y="1446.6545">sendMessage(providerRequest)</text></g><path d="M860,1423.6851 L860,1464.6851 L1108,1464.6851 L1108,1433.6851 L1098,1423.6851 L860,1423.6851" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M1098,1423.6851 L1098,1433.6851 L1108,1433.6851 L1098,1423.6851" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="227.9253" x="866" y="1441.7549">See Provider Orchestrator diagram</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="144.4917" x="866" y="1457.5542">for retry/fallback logic</text><g class="message" data-participant-1="PO" data-participant-2="AI"><polygon fill="#000000" points="1068.2373,1503.8823,1078.2373,1507.8823,1068.2373,1511.8823,1072.2373,1507.8823" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="855.1499" x2="1074.2373" y1="1507.8823" y2="1507.8823"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="157.5742" x="862.1499" y="1487.3535">POST /chat/completions</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="201.0874" x="862.1499" y="1503.1528">(with full conversation history)</text></g><g class="message" data-participant-1="AI" data-participant-2="PO"><polygon fill="#000000" points="866.1499,1533.6816,856.1499,1537.6816,866.1499,1541.6816,862.1499,1537.6816" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="860.1499" x2="1079.2373" y1="1537.6816" y2="1537.6816"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="156.5142" x="872.1499" y="1532.9521">Response with tool calls</text></g><path d="M783.8154,1552.6816 L847.8647,1552.6816 L847.8647,1560.481 L837.8647,1570.481 L783.8154,1570.481 L783.8154,1552.6816" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><rect fill="none" height="152.7959" style="stroke:#000000;stroke-width:1;" width="498.7471" x="783.8154" y="1552.6816"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19.0493" x="798.8154" y="1566.7515">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="126.2261" x="862.8647" y="1565.7407">[Tool calls required]</text><g class="message" data-participant-1="PO" data-participant-2="TR"><polygon fill="#000000" points="1197.5156,1588.2803,1207.5156,1592.2803,1197.5156,1596.2803,1201.5156,1592.2803" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="855.1499" x2="1203.5156" y1="1592.2803" y2="1592.2803"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="87.3374" x="862.1499" y="1587.5508">Execute tools</text></g><g class="message" data-participant-1="TR" data-participant-2="PO"><polygon fill="#000000" points="866.1499,1618.0796,856.1499,1622.0796,866.1499,1626.0796,862.1499,1622.0796" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="860.1499" x2="1208.5156" y1="1622.0796" y2="1622.0796"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="75.6831" x="872.1499" y="1617.3501">Tool results</text></g><g class="message" data-participant-1="PO" data-participant-2="AI"><polygon fill="#000000" points="1068.2373,1663.6782,1078.2373,1667.6782,1068.2373,1671.6782,1072.2373,1667.6782" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="855.1499" x2="1074.2373" y1="1667.6782" y2="1667.6782"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="157.5742" x="862.1499" y="1647.1494">POST /chat/completions</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="116.7271" x="862.1499" y="1662.9487">(with tool results)</text></g><g class="message" data-participant-1="AI" data-participant-2="PO"><polygon fill="#000000" points="866.1499,1693.4775,856.1499,1697.4775,866.1499,1701.4775,862.1499,1697.4775" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="860.1499" x2="1079.2373" y1="1697.4775" y2="1697.4775"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="94.0088" x="872.1499" y="1692.748">Final response</text></g><g class="message" data-participant-1="PO" data-participant-2="MS"><polygon fill="#000000" points="386.1162,1761.8755,376.1162,1765.8755,386.1162,1769.8755,382.1162,1765.8755" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="380.1162" x2="854.1499" y1="1765.8755" y2="1765.8755"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="116.2192" x="392.1162" y="1729.5474">ProviderResponse</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="204.8643" x="392.1162" y="1745.3467">{content, tokensIn, tokensOut,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="173.9956" x="392.1162" y="1761.146">latencyMs, providerCallId}</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1515.2271" x="5" y="1794.7751"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="1794.7751" y2="1794.7751"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="1797.7751" y2="1797.7751"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="252.9956" x="636.1157" y="1783.8755"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="234.5522" x="642.1157" y="1800.9453">Step 7: Store Assistant Message</text><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="728.2305,1835.4741,738.2305,1839.4741,728.2305,1843.4741,732.2305,1839.4741" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="375.1162" x2="734.2305" y1="1839.4741" y2="1839.4741"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="177.2646" x="382.1162" y="1834.7446">Get next sequence number</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="386.1162,1865.2734,376.1162,1869.2734,386.1162,1873.2734,382.1162,1869.2734" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="380.1162" x2="739.2305" y1="1869.2734" y2="1869.2734"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="141.3623" x="392.1162" y="1864.5439">sequenceNumber = 4</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="728.2305,1926.6714,738.2305,1930.6714,728.2305,1934.6714,732.2305,1930.6714" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="375.1162" x2="734.2305" y1="1930.6714" y2="1930.6714"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="156.292" x="382.1162" y="1894.3433">INSERT INTO messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="164.4043" x="382.1162" y="1910.1426">(sessionId, role, content,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="220.3018" x="382.1162" y="1925.9419">sequenceNumber, providerCallId)</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="386.1162,1956.4707,376.1162,1960.4707,386.1162,1964.4707,382.1162,1960.4707" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="380.1162" x2="739.2305" y1="1960.4707" y2="1960.4707"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="166.9561" x="392.1162" y="1955.7412">Assistant message stored</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1515.2271" x="5" y="1989.3704"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="1989.3704" y2="1989.3704"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="1992.3704" y2="1992.3704"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="217.1313" x="654.0479" y="1978.4707"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="198.688" x="660.0479" y="1995.5405">Step 8: Create Usage Event</text><g class="message" data-participant-1="MS" data-participant-2="BS"><polygon fill="#000000" points="1337.1196,2030.0693,1347.1196,2034.0693,1337.1196,2038.0693,1341.1196,2034.0693" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="375.1162" x2="1343.1196" y1="2034.0693" y2="2034.0693"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="207.7017" x="382.1162" y="2029.3398">createUsageEvent(providerCall)</text></g><g class="message" data-participant-1="BS" data-participant-2="DB"><polygon fill="#000000" points="751.2305,2107.2666,741.2305,2111.2666,751.2305,2115.2666,747.2305,2111.2666" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="745.2305" x2="1348.1196" y1="2111.2666" y2="2111.2666"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="148.1479" x="757.2305" y="2059.1392">Atomic check-and-set:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="148.002" x="757.2305" y="2074.9385">UPDATE provider_calls</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="110.7539" x="757.2305" y="2090.7378">SET billed = true</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="213.8652" x="757.2305" y="2106.5371">WHERE id = ? AND billed = false</text></g><path d="M686.6455,2126.2666 L750.6948,2126.2666 L750.6948,2134.0659 L740.6948,2144.0659 L686.6455,2144.0659 L686.6455,2126.2666" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><rect fill="none" height="226.7632" style="stroke:#000000;stroke-width:1;" width="813.5815" x="686.6455" y="2126.2666"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19.0493" x="701.6455" y="2140.3364">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="121.3975" x="765.6948" y="2139.3257">[Not already billed]</text><g class="message" data-participant-1="DB" data-participant-2="BS"><polygon fill="#000000" points="1337.1196,2161.8652,1347.1196,2165.8652,1337.1196,2169.8652,1341.1196,2165.8652" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="740.2305" x2="1343.1196" y1="2165.8652" y2="2165.8652"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="95.9702" x="747.2305" y="2161.1357">Updated 1 row</text></g><g class="message" data-participant-1="BS" data-participant-2="DB"><polygon fill="#000000" points="751.2305,2223.2632,741.2305,2227.2632,751.2305,2231.2632,747.2305,2227.2632" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="745.2305" x2="1348.1196" y1="2227.2632" y2="2227.2632"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="182.1523" x="757.2305" y="2190.9351">INSERT INTO usage_events</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="129.9429" x="757.2305" y="2206.7344">(tenantId, provider,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="212.1831" x="757.2305" y="2222.5337">tokensIn, tokensOut, costCents)</text></g><g class="message" data-participant-1="DB" data-participant-2="BS"><polygon fill="#000000" points="1337.1196,2253.0625,1347.1196,2257.0625,1337.1196,2261.0625,1341.1196,2257.0625" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="740.2305" x2="1343.1196" y1="2257.0625" y2="2257.0625"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="134.4497" x="747.2305" y="2252.333">Usage event created</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="686.6455" x2="1500.2271" y1="2266.0625" y2="2266.0625"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="96.9536" x="691.6455" y="2277.1216">[Already billed]</text><g class="message" data-participant-1="DB" data-participant-2="BS"><polygon fill="#000000" points="1337.1196,2298.2305,1347.1196,2302.2305,1337.1196,2306.2305,1341.1196,2302.2305" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="740.2305" x2="1343.1196" y1="2302.2305" y2="2302.2305"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="102.7432" x="747.2305" y="2297.501">Updated 0 rows</text></g><g class="message" data-participant-1="BS" data-participant-2="BS"><line style="stroke:#000000;stroke-width:1;" x1="1349.1196" x2="1391.1196" y1="2332.0298" y2="2332.0298"/><line style="stroke:#000000;stroke-width:1;" x1="1391.1196" x2="1391.1196" y1="2332.0298" y2="2345.0298"/><line style="stroke:#000000;stroke-width:1;" x1="1350.1196" x2="1391.1196" y1="2345.0298" y2="2345.0298"/><polygon fill="#000000" points="1360.1196,2341.0298,1350.1196,2345.0298,1360.1196,2349.0298,1356.1196,2345.0298" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="132.1074" x="1356.1196" y="2327.3003">Skip (already billed)</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1515.2271" x="5" y="2380.9294"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="2380.9294" y2="2380.9294"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1520.2271" y1="2383.9294" y2="2383.9294"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="239.418" x="642.9045" y="2370.0298"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="220.9746" x="648.9045" y="2387.0996">Step 9: Release Lock &amp; Return</text><g class="message" data-participant-1="MS" data-participant-2="MS"><line style="stroke:#000000;stroke-width:1;" x1="375.1162" x2="417.1162" y1="2425.6284" y2="2425.6284"/><line style="stroke:#000000;stroke-width:1;" x1="417.1162" x2="417.1162" y1="2425.6284" y2="2438.6284"/><line style="stroke:#000000;stroke-width:1;" x1="376.1162" x2="417.1162" y1="2438.6284" y2="2438.6284"/><polygon fill="#000000" points="386.1162,2434.6284,376.1162,2438.6284,386.1162,2442.6284,382.1162,2438.6284" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="133.231" x="382.1162" y="2420.8989">Release session lock</text></g><g class="message" data-participant-1="MS" data-participant-2="User"><polygon fill="#000000" points="54.9277,2669.8188,44.9277,2673.8188,54.9277,2677.8188,50.9277,2673.8188" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="48.9277" x2="374.1162" y1="2673.8188" y2="2673.8188"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="48.604" x="60.9277" y="2463.6982">200 OK</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="60.9277" y="2479.4976">{</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="131.2061" x="70.0684" y="2495.2969">"id": "msg_ghi789",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="139.4707" x="70.0684" y="2511.0962">"role": "ASSISTANT",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="298.0479" x="70.0684" y="2526.8955">"content": "Your order #12345 is shipped...",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="108.3926" x="70.0684" y="2542.6948">"toolCalls": [...],</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="92.8154" x="70.0684" y="2558.4941">"metadata": {</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="166.5308" x="79.209" y="2574.2935">"provider": "VENDOR_A",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="109.0781" x="79.209" y="2590.0928">"tokensIn": 150,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="118.9614" x="79.209" y="2605.8921">"tokensOut": 200,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="116.5938" x="79.209" y="2621.6914">"latencyMs": 450,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="136.5" x="79.209" y="2637.4907">"usedFallback": false</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="70.0684" y="2653.29">}</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="60.9277" y="2669.0894">}</text></g><path d="M604,2693.8188 L604,2781.8188 L876,2781.8188 L876,2703.8188 L866,2693.8188 L604,2693.8188" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M866,2693.8188 L866,2703.8188 L876,2703.8188 L866,2693.8188" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="149.7222" x="610" y="2711.8887">Key Tables Updated:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="251.4116" x="610" y="2727.688">- messages (2 rows: user + assistant)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="154.7051" x="610" y="2743.4873">- provider_calls (1 row)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="153.9814" x="610" y="2759.2866">- usage_events (1 row)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="208.7109" x="610" y="2775.0859">- tool_executions (if tools used)</text><path d="M231,2792.8154 L231,2896.8154 L519,2896.8154 L519,2802.8154 L509,2792.8154 L231,2792.8154" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M509,2792.8154 L509,2802.8154 L519,2802.8154 L509,2792.8154" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="124.8901" x="237" y="2810.8853">Critical Features:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="238.9521" x="237" y="2826.6846">&#9989; Idempotency prevents duplicates</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="266.5962" x="237" y="2842.4839">&#9989; Session lock prevents race conditions</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="262.7622" x="237" y="2858.2832">&#9989; Full conversation context maintained</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="264.0381" x="237" y="2874.0825">&#9989; Atomic billing prevents double-billing</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="267.1548" x="237" y="2889.8818">&#9989; Sequence numbers always sequential</text><!--SRC=[dLVhRjis5FwlfpXLWStExDopjWAomexjrMWIPxRQhgYBW94OcmXDgIALn0ZoSs-nfzkJx1pgOidEccqfWYhaHvxRTovyOUPymI6MJ2X7tmWLiuGju8e5DxCaIbLu4iaeWPU3Flrp72ECv70IBMB93OSphZMRSRX8eW0_XPh1G4Ptq8QFKS1aDn4XxevYxJWiC7ZH1yqJ1sKO4OYOAGDkSSM49xSYu2um3MSJ9sI6NJ7DmRs8j9abVFBRgTthTUldKVIj27aoLQCac7Dj4eQ2BFHYL8TsXb2WxNvdMD_teqZ2cCy4NhAq27zSHtI5b6HaLTdkn76EZs5YU0nx7dnaKg3o78OXNyIHuIfOml6nuv3fqFu5ZVDGiuaFEvfS5YczuubmPv7vGK_Lx-tAqVPxllHWeMUNgHBVKdwvjtzmU3HL3suGAKGOrmFtqvoP7pKibX0bQ1nemqogtxgFZdCs8PczhWUJ_cd_n8Sj68n7Px0Iz-bTVzo7N9TX2CVmTgewvpqGAorG2Lh7A4fJ1ft9XBDm2VmU7QOTm9zU5zgvYGDYJxP77ilbMHJfX2XoY8V-DccY860Ol10IhcFq29-gnlxkBepUDnqkaGNd_AvsHKNGUMJWceGvTgS8nRu7dU1RAXAYbhKDJgFWneQYK2Axe83bBW29C9GV9_mM_Qi17HsaIOBV49SyRzQb7NXuEminCp0ezsPDogRxYz0NxXVMx-kc5OetC0Z8ls7O0dH0zX6asaGBdWp3vlT5sHFF2EeG1XfwgGrVO8uiOjC2_8mvPbEQyDPKBTYz7zrmfLk0obn97bAww6U4FqEpqRZN7qFtCwuZjrN0pzF55UNowV1iwCFHxhgYwDzRdcXco2rpv5QKBAVgoqCIIOw9a2Abt1RagO4BxuJxYCf30M0e7hC3qwQ6ub96Bzp7h_MW7dhGJOKCowg1P4KrjNc2H7LWWRiJPWxNgPIPi7lZOUQYEb3rD2hmEKg18GKPpBcCyG2KYcvlRxjaGUbA3xxGdm3F6bt1VD_krZCN_cDzeNDVC-qAUdYmjxj_QDSg1F9WT_jLjaYiGHk6wZR24deQHJTftEFNGWaAwjUfUgn7uGWvXM7cjbwKnMSpmNxb1XJbNi4bK3cP6jWH5YB0GAY0P3JNMLLd7rBpOFtouVcaF_RnFtzKuNIZf7DhhLgYgUJCqecjDHaRAbZZyfk1QCtNwjdFI7w6H2gvMFV0nOZCK67k7wnUDIPcyXJg1ucOpGtL5hwwgzew8HHiXaF0L5tZ7md7NhXpZP9f9i3QE1D19lTYH78xmwAR1KYIdI2R3BBIrgZHVoDlCvsmARTp_STvyS_IXeY2RK5AdScZrkENQwYOhTgXtLlfuuyzwD_p84LBBTNAVNzS2hBNOAj9fT5hvv-tnrGEDylJ5JC6GZ5PTZABu4Lt8Y753516g6Xv3oLPZ4sbeIg-Hgb1HabcwNM69RW8Br5Y6AvbpAiYOpf5rl-Fj7asHmx_UuxKKsAgwdUkMxMH8ojplfSehp5HS30nL308qwSklcPu5syBBCXYBAHHbPx9xfQsTR8AWbaItBIP2jkQKot_SD7h-FrIxqjBpQcQz7sumb6HKvipIShhtHTekYhtCRUG9IN5QPmf9giCKt8iTmKf_o6c6JE4FVJfNGdeFXcBb4oyp8OPZCTgbYZKnaWyHJWCb3OdTAhvf0hMk_RQt9UPfdPUw_nh2tR90hrc0W4cDoA6HjqLpNes5I5_GxL3Sdeks1dlXsAgtEpJ1Quwx3cRKsasVERDsXKXJTaqXC_cujNhDrb3TedEjD6PJ8OJltFkv-kLoHmRUv8tpPTsSWUXGSz57FEmxEmkbHHYdSOZNt0vQwdkWXj6xo1SVSWwj5k4ZEx-s3_lZSQN7JTltsuHHDpSEzgjhs90NMjMiLmM4rm-NA6nzuU3lDhZZYKdRJrINxQEjqqamcfEJx6jBNeQ-3GFwYAatjQMqouh03JsROGzeB42VbfDDar4rJC76fRFj54bRMMPF7N9RNsdcWmDSPsLUReTwO4QsYvNLHDVarjR9mcE5oW41jmE99gq_ElFFshFj7Ba3zDO8jfmRJ6J2bbMe8HXiSHOXtPmoP23ZMQN3tuu80bby1UpWO1vGRdA7vGhoL6AlcpdwxdqMc7MM1xks5Bd5Ta89bTc_mq0]--></g></svg>