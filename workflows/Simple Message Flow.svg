<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="760px" preserveAspectRatio="none" style="width:994px;height:760px;background:#FEFEFE;" version="1.1" viewBox="0 0 994 760" width="994px" zoomAndPan="magnify"><title>Message Processing Flow - Simplified</title><defs/><g><rect fill="#FEFEFE" height="760" style="stroke:none;stroke-width:1;" width="994" x="0" y="0"/><text fill="#000000" font-family="Verdana" font-size="22" font-weight="bold" lengthAdjust="spacing" textLength="463.418" x="271.5779" y="37.1182">Message Processing Flow - Simplified</text><rect fill="#FFFFFF" height="392.5591" style="stroke:#000000;stroke-width:1;" width="801.3203" x="15" y="268.7485"/><rect fill="#FFFFFF" height="299.3618" style="stroke:none;stroke-width:1;" width="801.3203" x="15" y="361.9458"/><g><title>Client</title><rect fill="#000000" fill-opacity="0.00000" height="547.5557" width="8" x="44.0874" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="48" x2="48" y1="130.752" y2="678.3076"/></g><g><title>API Gateway</title><rect fill="#000000" fill-opacity="0.00000" height="547.5557" width="8" x="261.7861" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="265.7373" x2="265.7373" y1="130.752" y2="678.3076"/></g><g><title>Message Service</title><rect fill="#000000" fill-opacity="0.00000" height="547.5557" width="8" x="409.2173" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="412.835" x2="412.835" y1="130.752" y2="678.3076"/></g><g><title>Database</title><rect fill="#000000" fill-opacity="0.00000" height="547.5557" width="8" x="643.915" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="646.9727" x2="646.9727" y1="130.752" y2="678.3076"/></g><g><title>AI Provider</title><rect fill="#000000" fill-opacity="0.00000" height="547.5557" width="8" x="746.0889" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="749.8574" x2="749.8574" y1="130.752" y2="678.3076"/></g><g class="participant participant-head" data-participant="Client"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="40.1748" x="25" y="127.8125">Client</text><ellipse cx="48.0874" cy="61.7373" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1;"/><path d="M48.0874,69.7373 L48.0874,96.7373 M35.0874,77.7373 L61.0874,77.7373 M48.0874,96.7373 L35.0874,111.7373 M48.0874,96.7373 L61.0874,111.7373" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-tail" data-participant="Client"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="40.1748" x="25" y="691.3828">Client</text><ellipse cx="48.0874" cy="703.3223" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1;"/><path d="M48.0874,711.3223 L48.0874,738.3223 M35.0874,719.3223 L61.0874,719.3223 M48.0874,738.3223 L35.0874,753.3223 M48.0874,738.3223 L61.0874,753.3223" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-head" data-participant="API"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="104.0977" x="213.7373" y="98.7373"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="90.0977" x="220.7373" y="119.8125">API Gateway</text></g><g class="participant participant-tail" data-participant="API"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="104.0977" x="213.7373" y="677.3076"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="90.0977" x="220.7373" y="698.3828">API Gateway</text></g><g class="participant participant-head" data-participant="MS"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="130.7646" x="347.835" y="98.7373"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="116.7646" x="354.835" y="119.8125">Message Service</text></g><g class="participant participant-tail" data-participant="MS"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="130.7646" x="347.835" y="677.3076"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="116.7646" x="354.835" y="698.3828">Message Service</text></g><g class="participant participant-head" data-participant="DB"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="65.8848" x="611.9727" y="127.8125">Database</text><path d="M629.915,77.7373 C629.915,67.7373 647.915,67.7373 647.915,67.7373 C647.915,67.7373 665.915,67.7373 665.915,77.7373 L665.915,103.7373 C665.915,113.7373 647.915,113.7373 647.915,113.7373 C647.915,113.7373 629.915,113.7373 629.915,103.7373 L629.915,77.7373" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M629.915,77.7373 C629.915,87.7373 647.915,87.7373 647.915,87.7373 C647.915,87.7373 665.915,87.7373 665.915,77.7373" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-tail" data-participant="DB"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="65.8848" x="611.9727" y="691.3828">Database</text><path d="M629.915,704.3223 C629.915,694.3223 647.915,694.3223 647.915,694.3223 C647.915,694.3223 665.915,694.3223 665.915,704.3223 L665.915,730.3223 C665.915,740.3223 647.915,740.3223 647.915,740.3223 C647.915,740.3223 629.915,740.3223 629.915,730.3223 L629.915,704.3223" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M629.915,704.3223 C629.915,714.3223 647.915,714.3223 647.915,714.3223 C647.915,714.3223 665.915,714.3223 665.915,704.3223" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-head" data-participant="AI"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="92.4629" x="703.8574" y="98.7373"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="78.4629" x="710.8574" y="119.8125">AI Provider</text></g><g class="participant participant-tail" data-participant="AI"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="92.4629" x="703.8574" y="677.3076"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="78.4629" x="710.8574" y="698.3828">AI Provider</text></g><g class="message" data-participant-1="Client" data-participant-2="API"><polygon fill="#000000" points="253.7861,174.3506,263.7861,178.3506,253.7861,182.3506,257.7861,178.3506" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="48.0874" x2="259.7861" y1="178.3506" y2="178.3506"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="193.6987" x="55.0874" y="157.8218">POST /sessions/:id/messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="163.3569" x="55.0874" y="173.6211">X-Idempotency-Key: xyz</text></g><g class="message" data-participant-1="API" data-participant-2="MS"><polygon fill="#000000" points="401.2173,204.1499,411.2173,208.1499,401.2173,212.1499,405.2173,208.1499" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="265.7861" x2="407.2173" y1="208.1499" y2="208.1499"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="111.4966" x="272.7861" y="203.4204">Process message</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="635.915,249.7485,645.915,253.7485,635.915,257.7485,639.915,253.7485" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="413.2173" x2="641.915" y1="253.7485" y2="253.7485"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="175.0747" x="420.2173" y="233.2197">Check if already processed</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="123.1128" x="420.2173" y="249.019">(idempotency key)</text></g><path d="M15,268.7485 L79.0493,268.7485 L79.0493,276.5479 L69.0493,286.5479 L15,286.5479 L15,268.7485" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><rect fill="none" height="392.5591" style="stroke:#000000;stroke-width:1;" width="801.3203" x="15" y="268.7485"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19.0493" x="30" y="282.8184">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="125.5225" x="94.0493" y="281.8076">[Already processed]</text><path d="M821.3203,273.7485 L821.3203,393.7485 L987.3203,393.7485 L987.3203,283.7485 L977.3203,273.7485 L821.3203,273.7485" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M977.3203,273.7485 L977.3203,283.7485 L987.3203,283.7485 L977.3203,273.7485" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="77.3843" x="827.3203" y="291.8184">Key Steps:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="145.2534" x="827.3203" y="307.6177">1. Check idempotency</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="99.4741" x="827.3203" y="323.417">2. Lock session</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="101.7402" x="827.3203" y="339.2163">3. Load context</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="60.5122" x="827.3203" y="355.0156">4. Call AI</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="90.1431" x="827.3203" y="370.8149">5. Store &amp; bill</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="124.8394" x="827.3203" y="386.6143">6. Return response</text><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="424.2173,304.3472,414.2173,308.3472,424.2173,312.3472,420.2173,308.3472" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="418.2173" x2="646.915" y1="308.3472" y2="308.3472"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="153.2769" x="430.2173" y="303.6177">Found cached response</text></g><g class="message" data-participant-1="MS" data-participant-2="Client"><polygon fill="#000000" points="59.0874,349.9458,49.0874,353.9458,59.0874,357.9458,55.0874,353.9458" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="53.0874" x2="412.2173" y1="353.9458" y2="353.9458"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="157.2695" x="65.0874" y="333.417">Return cached response</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="121.1831" x="65.0874" y="349.2163">(no re-processing)</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="15" x2="816.3203" y1="362.9458" y2="362.9458"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="97.4478" x="20" y="374.0049">[New message]</text><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="424.2173,395.1138,414.2173,399.1138,424.2173,403.1138,420.2173,399.1138" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="418.2173" x2="646.915" y1="399.1138" y2="399.1138"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="64.3208" x="430.2173" y="394.3843">Not found</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="635.915,440.7124,645.915,444.7124,635.915,448.7124,639.915,444.7124" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="413.2173" x2="641.915" y1="444.7124" y2="444.7124"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="81.9102" x="420.2173" y="424.1836">Lock session</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="210.6978" x="420.2173" y="439.9829">(prevent concurrent processing)</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="635.915,470.5117,645.915,474.5117,635.915,478.5117,639.915,474.5117" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="413.2173" x2="641.915" y1="474.5117" y2="474.5117"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="168.2573" x="420.2173" y="469.7822">Load conversation history</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="424.2173,500.311,414.2173,504.311,424.2173,508.311,420.2173,504.311" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="418.2173" x2="646.915" y1="504.311" y2="504.311"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="124.2109" x="430.2173" y="499.5815">Previous messages</text></g><g class="message" data-participant-1="MS" data-participant-2="AI"><polygon fill="#000000" points="738.0889,530.1104,748.0889,534.1104,738.0889,538.1104,742.0889,534.1104" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="413.2173" x2="744.0889" y1="534.1104" y2="534.1104"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="180.3813" x="420.2173" y="529.3809">Send message with context</text></g><g class="message" data-participant-1="AI" data-participant-2="MS"><polygon fill="#000000" points="424.2173,559.9097,414.2173,563.9097,424.2173,567.9097,420.2173,563.9097" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="418.2173" x2="749.0889" y1="563.9097" y2="563.9097"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="77.7271" x="430.2173" y="559.1802">AI response</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="635.915,589.709,645.915,593.709,635.915,597.709,639.915,593.709" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="413.2173" x2="641.915" y1="593.709" y2="593.709"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="155.7778" x="420.2173" y="588.9795">Store message + usage</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="635.915,619.5083,645.915,623.5083,635.915,627.5083,639.915,623.5083" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="413.2173" x2="641.915" y1="623.5083" y2="623.5083"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="80.9136" x="420.2173" y="618.7788">Release lock</text></g><g class="message" data-participant-1="MS" data-participant-2="Client"><polygon fill="#000000" points="59.0874,649.3076,49.0874,653.3076,59.0874,657.3076,55.0874,653.3076" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="53.0874" x2="412.2173" y1="653.3076" y2="653.3076"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="107.2754" x="65.0874" y="648.5781">Return response</text></g><!--SRC=[VLBBRjim4BppAxOkK3Gk9AFFWmu5_AWBetLgH3dqa0jDhIt254cGb1trwxkqP2LMWqeNFeOpixFxAfHO8LZ5fMR-8BNbZbUmvUAmTwRMnTmeu-3rybly6GioA8GrUi_t21jd12sbtiDIcHCaaClAAhcJM336HQ2dSoLH1qQyGGffkGumccvMy9q7FF5c1Dm3xQy15u4StL4AF8FMEIjuu5lk4KQBRdM-MSm6zAlex2WBT2tzYh7M1YHVerW6cr_vFKnyD6-qdsIoc5Ijfd_GlvDLWPKr0RLeaX_OPF3O_64isYQ2TPvTAeVk4MFhF5ujPXdCInG7a3lWoY4l6h0j5ei7_LO-4SC1cnjAIGMO3f4Cw5lC8Edabh4L8BWeiG27tf9fF8EYBe7QyZAumr0xFKIIi3QqIspVi1k6YeAynLDVmq3prWJOHLtM2xK5_ZHKNnSTCLk7nnYjC5hKpiNbSvb_7lCYGe_eF0_40ANqD2VDK7v3jDBKVSJ-ETEKMfWZHT9Tmac6Cj86V0nd7Ct0XOcMVMG3DpafOq_o3kgscTUWErGOXqvHtUm_eVSY63FJr6LmSbz6F-CnJH6feVNPU4m7xzFBd3mD11r_IA_IfPEFQHzPLzidUigLYbCDy3djQdW3MwaKdNn9N_83qGxx2m00]--></g></svg>