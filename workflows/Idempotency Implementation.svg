<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="6154px" preserveAspectRatio="none" style="width:1700px;height:6154px;background:#FEFEFE;" version="1.1" viewBox="0 0 1700 6154" width="1700px" zoomAndPan="magnify"><title>Idempotency - Preventing Duplicate Message Processing</title><defs/><g><rect fill="#FEFEFE" height="6154" style="stroke:none;stroke-width:1;" width="1700" x="0" y="0"/><text fill="#000000" font-family="Verdana" font-size="22" font-weight="bold" lengthAdjust="spacing" textLength="703.6133" x="497.1912" y="37.1182">Idempotency - Preventing Duplicate Message Processing</text><rect fill="#FFFFFF" height="670.1836" style="stroke:#000000;stroke-width:1;" width="1215.3564" x="468.6392" y="3004.0645"/><g><title>Client</title><rect fill="#000000" fill-opacity="0.00000" height="5941.8154" width="8" x="242.0874" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="246" x2="246" y1="130.752" y2="6072.5674"/></g><g><title>API Gateway</title><rect fill="#000000" fill-opacity="0.00000" height="5941.8154" width="8" x="536.688" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="540.6392" x2="540.6392" y1="130.752" y2="6072.5674"/></g><g><title>Message Service</title><rect fill="#000000" fill-opacity="0.00000" height="5941.8154" width="8" x="798.9028" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="802.5205" x2="802.5205" y1="130.752" y2="6072.5674"/></g><g><title>PostgreSQL</title><rect fill="#000000" fill-opacity="0.00000" height="5941.8154" width="8" x="1120.373" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="1123.7881" x2="1123.7881" y1="130.752" y2="6072.5674"/></g><g><title>Provider</title><rect fill="#000000" fill-opacity="0.00000" height="5941.8154" width="8" x="1219.9971" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="1223.958" x2="1223.958" y1="130.752" y2="6072.5674"/></g><g><title>Client</title><rect fill="#000000" fill-opacity="0.00000" height="5941.8154" width="8" x="1324.4131" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="1328.0361" x2="1328.0361" y1="130.752" y2="6072.5674"/></g><g><title>Client</title><rect fill="#000000" fill-opacity="0.00000" height="5941.8154" width="8" x="1431.167" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="1434.79" x2="1434.79" y1="130.752" y2="6072.5674"/></g><g class="participant participant-head" data-participant="Client"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="40.1748" x="223" y="127.8125">Client</text><ellipse cx="246.0874" cy="61.7373" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1;"/><path d="M246.0874,69.7373 L246.0874,96.7373 M233.0874,77.7373 L259.0874,77.7373 M246.0874,96.7373 L233.0874,111.7373 M246.0874,96.7373 L259.0874,111.7373" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-tail" data-participant="Client"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="40.1748" x="223" y="6085.6426">Client</text><ellipse cx="246.0874" cy="6097.582" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1;"/><path d="M246.0874,6105.582 L246.0874,6132.582 M233.0874,6113.582 L259.0874,6113.582 M246.0874,6132.582 L233.0874,6147.582 M246.0874,6132.582 L259.0874,6147.582" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-head" data-participant="API"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="104.0977" x="488.6392" y="98.7373"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="90.0977" x="495.6392" y="119.8125">API Gateway</text></g><g class="participant participant-tail" data-participant="API"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="104.0977" x="488.6392" y="6071.5674"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="90.0977" x="495.6392" y="6092.6426">API Gateway</text></g><g class="participant participant-head" data-participant="MS"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="130.7646" x="737.5205" y="98.7373"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="116.7646" x="744.5205" y="119.8125">Message Service</text></g><g class="participant participant-tail" data-participant="MS"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="130.7646" x="737.5205" y="6071.5674"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="116.7646" x="744.5205" y="6092.6426">Message Service</text></g><g class="participant participant-head" data-participant="DB"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="81.1699" x="1080.7881" y="127.8125">PostgreSQL</text><path d="M1106.373,77.7373 C1106.373,67.7373 1124.373,67.7373 1124.373,67.7373 C1124.373,67.7373 1142.373,67.7373 1142.373,77.7373 L1142.373,103.7373 C1142.373,113.7373 1124.373,113.7373 1124.373,113.7373 C1124.373,113.7373 1106.373,113.7373 1106.373,103.7373 L1106.373,77.7373" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M1106.373,77.7373 C1106.373,87.7373 1124.373,87.7373 1124.373,87.7373 C1124.373,87.7373 1142.373,87.7373 1142.373,77.7373" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-tail" data-participant="DB"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="81.1699" x="1080.7881" y="6085.6426">PostgreSQL</text><path d="M1106.373,6098.582 C1106.373,6088.582 1124.373,6088.582 1124.373,6088.582 C1124.373,6088.582 1142.373,6088.582 1142.373,6098.582 L1142.373,6124.582 C1142.373,6134.582 1124.373,6134.582 1124.373,6134.582 C1124.373,6134.582 1106.373,6134.582 1106.373,6124.582 L1106.373,6098.582" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M1106.373,6098.582 C1106.373,6108.582 1124.373,6108.582 1124.373,6108.582 C1124.373,6108.582 1142.373,6108.582 1142.373,6098.582" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-head" data-participant="PRV"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="72.0781" x="1187.958" y="98.7373"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="58.0781" x="1194.958" y="119.8125">Provider</text></g><g class="participant participant-tail" data-participant="PRV"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="72.0781" x="1187.958" y="6071.5674"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="58.0781" x="1194.958" y="6092.6426">Provider</text></g><g class="participant participant-head" data-participant="C1"><rect fill="#FFFFFF" height="48.0293" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="76.7539" x="1290.0361" y="81.7227"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="40.1748" x="1308.3257" y="102.7979">Client</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="62.7539" x="1297.0361" y="119.8125">Thread 1</text></g><g class="participant participant-tail" data-participant="C1"><rect fill="#FFFFFF" height="48.0293" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="76.7539" x="1290.0361" y="6071.5674"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="40.1748" x="1308.3257" y="6092.6426">Client</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="62.7539" x="1297.0361" y="6109.6572">Thread 1</text></g><g class="participant participant-head" data-participant="C2"><rect fill="#FFFFFF" height="48.0293" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="76.7539" x="1396.79" y="81.7227"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="40.1748" x="1415.0796" y="102.7979">Client</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="62.7539" x="1403.79" y="119.8125">Thread 2</text></g><g class="participant participant-tail" data-participant="C2"><rect fill="#FFFFFF" height="48.0293" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="76.7539" x="1396.79" y="6071.5674"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="40.1748" x="1415.0796" y="6092.6426">Client</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="62.7539" x="1403.79" y="6109.6572">Thread 2</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1688.9956" x="5" y="161.6516"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1693.9956" y1="161.6516" y2="161.6516"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1693.9956" y1="164.6516" y2="164.6516"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="224.5771" x="737.2092" y="150.752"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="206.1338" x="743.2092" y="167.8218">First Request: New Message</text><g class="message" data-participant-1="Client" data-participant-2="API"><polygon fill="#000000" points="528.688,265.5479,538.688,269.5479,528.688,273.5479,532.688,269.5479" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="246.0874" x2="534.688" y1="269.5479" y2="269.5479"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="193.6987" x="253.0874" y="201.6211">POST /sessions/:id/messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="270.6006" x="253.0874" y="217.4204">X-Idempotency-Key: msg_unique_12345</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="253.0874" y="233.2197">{</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="248.1616" x="262.228" y="249.019">"content": "What is my order status?"</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="253.0874" y="264.8184">}</text></g><path d="M251,282.5479 L251,323.5479 L475,323.5479 L475,292.5479 L465,282.5479 L251,282.5479" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M465,282.5479 L465,292.5479 L475,292.5479 L465,282.5479" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="183.0474" x="257" y="300.6177">Client generates unique key</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="203.2456" x="257" y="316.417">(UUID, timestamp-based, etc.)</text><g class="message" data-participant-1="API" data-participant-2="MS"><polygon fill="#000000" points="790.9028,410.1431,800.9028,414.1431,790.9028,418.1431,794.9028,414.1431" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="540.688" x2="796.9028" y1="414.1431" y2="414.1431"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="111.4014" x="547.688" y="346.2163">processMessage(</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="66.0474" x="547.688" y="362.0156">sessionId,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="53.8345" x="547.688" y="377.8149">content,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="108.0498" x="547.688" y="393.6143">idempotencyKey</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="5.9033" x="547.688" y="409.4136">)</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,471.541,1122.373,475.541,1112.373,479.541,1116.373,475.541" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="475.541" y2="475.541"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="173.6846" x="809.9028" y="439.2129">SELECT * FROM messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="140.8608" x="809.9028" y="455.0122">WHERE sessionId = ?</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="297.4702" x="809.9028" y="470.8115">AND idempotencyKey = 'msg_unique_12345'</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="813.9028,501.3403,803.9028,505.3403,813.9028,509.3403,809.9028,505.3403" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="807.9028" x2="1123.373" y1="505.3403" y2="505.3403"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="94.6182" x="819.9028" y="500.6108">No rows found</text></g><path d="M807,518.3403 L807,559.3403 L974,559.3403 L974,528.3403 L964,518.3403 L807,518.3403" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M964,518.3403 L964,528.3403 L974,528.3403 L964,518.3403" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="140.9116" x="813" y="536.4102">Key not found: this is</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="146.2056" x="813" y="552.2095">a new, unique request</text><g class="message" data-participant-1="MS" data-participant-2="MS"><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="844.9028" y1="586.7383" y2="586.7383"/><line style="stroke:#000000;stroke-width:1;" x1="844.9028" x2="844.9028" y1="586.7383" y2="599.7383"/><line style="stroke:#000000;stroke-width:1;" x1="803.9028" x2="844.9028" y1="599.7383" y2="599.7383"/><polygon fill="#000000" points="813.9028,595.7383,803.9028,599.7383,813.9028,603.7383,809.9028,599.7383" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="157.8281" x="809.9028" y="582.0088">Proceed with processing</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,641.3369,1122.373,645.3369,1112.373,649.3369,1116.373,645.3369" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="645.3369" y2="645.3369"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="131.6567" x="809.9028" y="624.8081">Acquire session lock</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="217.4707" x="809.9028" y="640.6074">(prevents concurrent processing)</text></g><g class="message" data-participant-1="MS" data-participant-2="MS"><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="844.9028" y1="690.9355" y2="690.9355"/><line style="stroke:#000000;stroke-width:1;" x1="844.9028" x2="844.9028" y1="690.9355" y2="703.9355"/><line style="stroke:#000000;stroke-width:1;" x1="803.9028" x2="844.9028" y1="703.9355" y2="703.9355"/><polygon fill="#000000" points="813.9028,699.9355,803.9028,703.9355,813.9028,707.9355,809.9028,703.9355" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="172.0088" x="809.9028" y="670.4067">Load conversation context</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="159.9736" x="809.9028" y="686.2061">(session, agent, history)</text></g><g class="message" data-participant-1="MS" data-participant-2="PRV"><polygon fill="#000000" points="1211.9971,745.5342,1221.9971,749.5342,1211.9971,753.5342,1215.9971,749.5342" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1217.9971" y1="749.5342" y2="749.5342"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="101.7085" x="809.9028" y="729.0054">Call AI provider</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="117.0063" x="809.9028" y="744.8047">(with full context)</text></g><g class="message" data-participant-1="PRV" data-participant-2="MS"><polygon fill="#000000" points="813.9028,775.3335,803.9028,779.3335,813.9028,783.3335,809.9028,779.3335" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="807.9028" x2="1222.9971" y1="779.3335" y2="779.3335"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="77.7271" x="819.9028" y="774.604">AI response</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,805.1328,1122.373,809.1328,1112.373,813.1328,1116.373,809.1328" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="809.1328" y2="809.1328"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="177.2646" x="809.9028" y="804.4033">Get next sequence number</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="813.9028,834.9321,803.9028,838.9321,813.9028,842.9321,809.9028,838.9321" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="807.9028" x2="1123.373" y1="838.9321" y2="838.9321"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="141.3623" x="819.9028" y="834.2026">sequenceNumber = 5</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,864.7314,1122.373,868.7314,1112.373,872.7314,1116.373,868.7314" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="868.7314" y2="868.7314"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="142.9302" x="809.9028" y="864.002">BEGIN TRANSACTION</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,941.9287,1122.373,945.9287,1112.373,949.9287,1116.373,945.9287" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="945.9287" y2="945.9287"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="118.2822" x="809.9028" y="893.8013">INSERT messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="189.2998" x="809.9028" y="909.6006">(sessionId, idempotencyKey,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="134.0181" x="809.9028" y="925.3999">role: USER, content,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="137.96" x="809.9028" y="941.1992">sequenceNumber: 5)</text></g><path d="M1129,886.6311 L1129,943.6311 L1353,943.6311 L1353,896.6311 L1343,886.6311 L1129,886.6311" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M1343,886.6311 L1343,896.6311 L1353,896.6311 L1343,886.6311" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="135.6938" x="1135" y="904.7009">Unique constraint on</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="190.4741" x="1135" y="920.5002">(sessionId, idempotencyKey)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="203.1885" x="1135" y="936.2996">prevents duplicates at DB level</text><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,1019.126,1122.373,1023.126,1112.373,1027.126,1116.373,1023.126" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="1023.126" y2="1023.126"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="118.2822" x="809.9028" y="970.9985">INSERT messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="192.1245" x="809.9028" y="986.7979">(sessionId, role: ASSISTANT,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="195.1904" x="809.9028" y="1002.5972">content, sequenceNumber: 6,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="97.6841" x="809.9028" y="1018.3965">providerCallId)</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,1080.5239,1122.373,1084.5239,1112.373,1088.5239,1116.373,1084.5239" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="1084.5239" y2="1084.5239"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="144.8662" x="809.9028" y="1048.1958">INSERT provider_calls</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="157.3774" x="809.9028" y="1063.9951">(correlationId, provider,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="188.5063" x="809.9028" y="1079.7944">tokensIn, tokensOut, status)</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,1141.9219,1122.373,1145.9219,1112.373,1149.9219,1116.373,1145.9219" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="1145.9219" y2="1145.9219"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="144.1426" x="809.9028" y="1109.5938">INSERT usage_events</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="167.5337" x="809.9028" y="1125.3931">(tenantId, providerCallId,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="212.1831" x="809.9028" y="1141.1924">tokensIn, tokensOut, costCents)</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,1171.7212,1122.373,1175.7212,1112.373,1179.7212,1116.373,1175.7212" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="1175.7212" y2="1175.7212"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="155.2256" x="809.9028" y="1170.9917">COMMIT TRANSACTION</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="813.9028,1201.5205,803.9028,1205.5205,813.9028,1209.5205,809.9028,1205.5205" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="807.9028" x2="1123.373" y1="1205.5205" y2="1205.5205"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="143.146" x="819.9028" y="1200.791">All records committed</text></g><g class="message" data-participant-1="MS" data-participant-2="MS"><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="844.9028" y1="1235.3198" y2="1235.3198"/><line style="stroke:#000000;stroke-width:1;" x1="844.9028" x2="844.9028" y1="1235.3198" y2="1248.3198"/><line style="stroke:#000000;stroke-width:1;" x1="803.9028" x2="844.9028" y1="1248.3198" y2="1248.3198"/><polygon fill="#000000" points="813.9028,1244.3198,803.9028,1248.3198,813.9028,1252.3198,809.9028,1248.3198" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="133.231" x="809.9028" y="1230.5903">Release session lock</text></g><g class="message" data-participant-1="MS" data-participant-2="API"><polygon fill="#000000" points="551.688,1353.1157,541.688,1357.1157,551.688,1361.1157,547.688,1357.1157" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="545.688" x2="801.9028" y1="1357.1157" y2="1357.1157"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="62.2896" x="557.688" y="1273.3896">Response</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="557.688" y="1289.189">{</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="75.8862" x="566.8286" y="1304.9883">messageId,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="53.8345" x="566.8286" y="1320.7876">content,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="103.3208" x="566.8286" y="1336.5869">metadata: {...}</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="557.688" y="1352.3862">}</text></g><g class="message" data-participant-1="API" data-participant-2="Client"><polygon fill="#000000" points="257.0874,1477.7109,247.0874,1481.7109,257.0874,1485.7109,253.0874,1481.7109" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="251.0874" x2="539.688" y1="1481.7109" y2="1481.7109"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="48.604" x="263.0874" y="1382.1855">200 OK</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="263.0874" y="1397.9849">{</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="142.2573" x="272.228" y="1413.7842">"id": "msg_abc_789",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="139.4707" x="272.228" y="1429.5835">"role": "ASSISTANT",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="227.957" x="272.228" y="1445.3828">"content": "Your order #12345...",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="115.2544" x="272.228" y="1461.1821">"metadata": {...}</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="263.0874" y="1476.9814">}</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1688.9956" x="5" y="1510.6106"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1693.9956" y1="1510.6106" y2="1510.6106"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1693.9956" y1="1513.6106" y2="1513.6106"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="333.7251" x="682.6353" y="1499.7109"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="315.2817" x="688.6353" y="1516.7808">Duplicate Request: Same Idempotency Key</text><path d="M138,1538.5103 L138,1595.5103 L352,1595.5103 L352,1548.5103 L342,1538.5103 L138,1538.5103" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M342,1538.5103 L342,1548.5103 L352,1548.5103 L342,1538.5103" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="188.0938" x="144" y="1556.5801">Network glitch or client retry</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="193.6289" x="144" y="1572.3794">causes duplicate request with</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="152.8262" x="144" y="1588.1787">SAME idempotency key</text><g class="message" data-participant-1="Client" data-participant-2="API"><polygon fill="#000000" points="528.688,1681.9048,538.688,1685.9048,528.688,1689.9048,532.688,1685.9048" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="246.0874" x2="534.688" y1="1685.9048" y2="1685.9048"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="193.6987" x="253.0874" y="1617.978">POST /sessions/:id/messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="270.6006" x="253.0874" y="1633.7773">X-Idempotency-Key: msg_unique_12345</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="253.0874" y="1649.5767">{</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="248.1616" x="262.228" y="1665.376">"content": "What is my order status?"</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="253.0874" y="1681.1753">}</text></g><path d="M251,1698.9048 L251,1739.9048 L424,1739.9048 L424,1708.9048 L414,1698.9048 L251,1698.9048" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M414,1698.9048 L414,1708.9048 L424,1708.9048 L414,1698.9048" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="152.8262" x="257" y="1716.9746">SAME idempotency key</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="128.521" x="257" y="1732.7739">as previous request</text><g class="message" data-participant-1="API" data-participant-2="MS"><polygon fill="#000000" points="790.9028,1826.5,800.9028,1830.5,790.9028,1834.5,794.9028,1830.5" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="540.688" x2="796.9028" y1="1830.5" y2="1830.5"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="111.4014" x="547.688" y="1762.5732">processMessage(</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="66.0474" x="547.688" y="1778.3726">sessionId,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="53.8345" x="547.688" y="1794.1719">content,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="108.0498" x="547.688" y="1809.9712">idempotencyKey</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="5.9033" x="547.688" y="1825.7705">)</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,1887.8979,1122.373,1891.8979,1112.373,1895.8979,1116.373,1891.8979" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="1891.8979" y2="1891.8979"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="173.6846" x="809.9028" y="1855.5698">SELECT * FROM messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="140.8608" x="809.9028" y="1871.3691">WHERE sessionId = ?</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="297.4702" x="809.9028" y="1887.1685">AND idempotencyKey = 'msg_unique_12345'</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="813.9028,2012.4932,803.9028,2016.4932,813.9028,2020.4932,809.9028,2016.4932" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="807.9028" x2="1123.373" y1="2016.4932" y2="2016.4932"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="102.5972" x="819.9028" y="1916.9678">Message found!</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="819.9028" y="1932.7671">{</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="130.3237" x="829.0435" y="1948.5664">id: "msg_abc_789",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="127.5371" x="829.0435" y="1964.3657">role: "ASSISTANT",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="216.0234" x="829.0435" y="1980.165">content: "Your order #12345...",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="103.3208" x="829.0435" y="1995.9644">metadata: {...}</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="819.9028" y="2011.7637">}</text></g><path d="M807,2029.4932 L807,2070.4932 L955,2070.4932 L955,2039.4932 L945,2029.4932 L807,2029.4932" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M945,2029.4932 L945,2039.4932 L955,2039.4932 L945,2029.4932" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="127.48" x="813" y="2047.563">Key found: this is a</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="112.8359" x="813" y="2063.3623">duplicate request</text><g class="message" data-participant-1="MS" data-participant-2="MS"><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="844.9028" y1="2113.6904" y2="2113.6904"/><line style="stroke:#000000;stroke-width:1;" x1="844.9028" x2="844.9028" y1="2113.6904" y2="2126.6904"/><line style="stroke:#000000;stroke-width:1;" x1="803.9028" x2="844.9028" y1="2126.6904" y2="2126.6904"/><polygon fill="#000000" points="813.9028,2122.6904,803.9028,2126.6904,813.9028,2130.6904,809.9028,2126.6904" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="157.2695" x="809.9028" y="2093.1616">Return cached response</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="144.0029" x="809.9028" y="2108.9609">(don't process again!)</text></g><path d="M807,2139.6904 L807,2227.6904 L1026,2227.6904 L1026,2149.6904 L1016,2139.6904 L807,2139.6904" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M1016,2139.6904 L1016,2149.6904 L1026,2149.6904 L1016,2139.6904" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="75.645" x="813" y="2157.7603">CRITICAL:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="114.3213" x="813" y="2173.5596">&#8226; No provider call</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="72.541" x="813" y="2189.3589">&#8226; No billing</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="129.3843" x="813" y="2205.1582">&#8226; No new messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="198.8911" x="813" y="2220.9575">&#8226; Just return original response</text><g class="message" data-participant-1="MS" data-participant-2="API"><polygon fill="#000000" points="551.688,2330.4829,541.688,2334.4829,551.688,2338.4829,547.688,2334.4829" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="545.688" x2="801.9028" y1="2334.4829" y2="2334.4829"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="111.0967" x="557.688" y="2250.7568">Cached response</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="557.688" y="2266.5562">{</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="75.8862" x="566.8286" y="2282.3555">messageId,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="53.8345" x="566.8286" y="2298.1548">content,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="103.3208" x="566.8286" y="2313.9541">metadata: {...}</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="557.688" y="2329.7534">}</text></g><g class="message" data-participant-1="API" data-participant-2="Client"><polygon fill="#000000" points="257.0874,2455.0781,247.0874,2459.0781,257.0874,2463.0781,253.0874,2459.0781" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="251.0874" x2="539.688" y1="2459.0781" y2="2459.0781"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="48.604" x="263.0874" y="2359.5527">200 OK</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="263.0874" y="2375.3521">{</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="142.2573" x="272.228" y="2391.1514">"id": "msg_abc_789",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="139.4707" x="272.228" y="2406.9507">"role": "ASSISTANT",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="227.957" x="272.228" y="2422.75">"content": "Your order #12345...",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="115.2544" x="272.228" y="2438.5493">"metadata": {...}</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="263.0874" y="2454.3486">}</text></g><path d="M251,2472.0781 L251,2529.0781 L489,2529.0781 L489,2482.0781 L479,2472.0781 L251,2472.0781" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M479,2472.0781 L479,2482.0781 L489,2482.0781 L479,2472.0781" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="217.877" x="257" y="2490.1479">Client receives identical response</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="163.998" x="257" y="2505.9473">No way to tell it's cached</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="176.0078" x="257" y="2521.7466">(transparent idempotency)</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1688.9956" x="5" y="2555.3757"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1693.9956" y1="2555.3757" y2="2555.3757"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1693.9956" y1="2558.3757" y2="2558.3757"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="290.1929" x="704.4014" y="2544.4761"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="271.7495" x="710.4014" y="2561.5459">Concurrent Requests: Race Condition</text><g class="message" data-participant-1="C1" data-participant-2="API"><polygon fill="#000000" points="551.688,2596.0747,541.688,2600.0747,551.688,2604.0747,547.688,2600.0747" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="545.688" x2="1327.4131" y1="2600.0747" y2="2600.0747"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="201.9824" x="557.688" y="2595.3452">POST with key: msg_race_999</text></g><g class="message" data-participant-1="C2" data-participant-2="API"><polygon fill="#000000" points="551.688,2641.6733,541.688,2645.6733,551.688,2649.6733,547.688,2645.6733" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="545.688" x2="1434.167" y1="2645.6733" y2="2645.6733"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="201.9824" x="557.688" y="2625.1445">POST with key: msg_race_999</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="125.3599" x="557.688" y="2640.9438">(milliseconds later)</text></g><path d="M1272,2658.6733 L1272,2699.6733 L1490,2699.6733 L1490,2668.6733 L1480,2658.6733 L1272,2658.6733" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M1480,2658.6733 L1480,2668.6733 L1490,2668.6733 L1480,2658.6733" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="178.3882" x="1278" y="2676.7432">Both requests arrive nearly</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="197.1963" x="1278" y="2692.5425">simultaneously with same key</text><g class="message" data-participant-1="API" data-participant-2="MS"><polygon fill="#000000" points="790.9028,2723.0713,800.9028,2727.0713,790.9028,2731.0713,794.9028,2727.0713" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="540.688" x2="796.9028" y1="2727.0713" y2="2727.0713"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="174.2432" x="547.688" y="2722.3418">Thread 1: processMessage</text></g><g class="message" data-participant-1="API" data-participant-2="MS"><polygon fill="#000000" points="790.9028,2752.8706,800.9028,2756.8706,790.9028,2760.8706,794.9028,2756.8706" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="540.688" x2="796.9028" y1="2756.8706" y2="2756.8706"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="174.2432" x="547.688" y="2752.1411">Thread 2: processMessage</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,2798.4692,1122.373,2802.4692,1112.373,2806.4692,1116.373,2802.4692" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="2802.4692" y2="2802.4692"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="132.5835" x="809.9028" y="2781.9404">Thread 1: SELECT...</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="284.1973" x="809.9028" y="2797.7397">WHERE idempotencyKey = 'msg_race_999'</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,2844.0679,1122.373,2848.0679,1112.373,2852.0679,1116.373,2848.0679" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="2848.0679" y2="2848.0679"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="132.5835" x="809.9028" y="2827.5391">Thread 2: SELECT...</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="284.1973" x="809.9028" y="2843.3384">WHERE idempotencyKey = 'msg_race_999'</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="813.9028,2873.8672,803.9028,2877.8672,813.9028,2881.8672,809.9028,2877.8672" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="807.9028" x2="1123.373" y1="2877.8672" y2="2877.8672"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="133.0659" x="819.9028" y="2873.1377">Thread 1: Not found</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="813.9028,2903.6665,803.9028,2907.6665,813.9028,2911.6665,809.9028,2907.6665" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="807.9028" x2="1123.373" y1="2907.6665" y2="2907.6665"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="133.0659" x="819.9028" y="2902.937">Thread 2: Not found</text></g><path d="M807,2920.6665 L807,2961.6665 L1018,2961.6665 L1018,2930.6665 L1008,2920.6665 L807,2920.6665" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M1008,2920.6665 L1008,2930.6665 L1018,2930.6665 L1008,2920.6665" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="190.2012" x="813" y="2938.7363">Both threads see "not found"</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="100.4136" x="813" y="2954.5356">Race condition!</text><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,2985.0645,1122.373,2989.0645,1112.373,2993.0645,1116.373,2989.0645" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="2989.0645" y2="2989.0645"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="200.4019" x="809.9028" y="2984.335">Thread 1: Acquire session lock</text></g><path d="M468.6392,3004.0645 L532.6885,3004.0645 L532.6885,3011.8638 L522.6885,3021.8638 L468.6392,3021.8638 L468.6392,3004.0645" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><rect fill="none" height="670.1836" style="stroke:#000000;stroke-width:1;" width="1215.3564" x="468.6392" y="3004.0645"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19.0493" x="483.6392" y="3018.1343">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="155.0688" x="547.6885" y="3017.1235">[Thread 1 gets lock first]</text><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="813.9028,3039.6631,803.9028,3043.6631,813.9028,3047.6631,809.9028,3043.6631" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="807.9028" x2="1123.373" y1="3043.6631" y2="3043.6631"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="158.7739" x="819.9028" y="3038.9336">Thread 1: Lock acquired</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,3069.4624,1122.373,3073.4624,1112.373,3077.4624,1116.373,3073.4624" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="3073.4624" y2="3073.4624"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="172.8276" x="809.9028" y="3068.7329">Thread 2: Try acquire lock</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="813.9028,3115.061,803.9028,3119.061,813.9028,3123.061,809.9028,3119.061" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="807.9028" x2="1123.373" y1="3119.061" y2="3119.061"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="144.2314" x="819.9028" y="3098.5322">Thread 2: Lock wait...</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="144.8789" x="819.9028" y="3114.3315">(blocked by Thread 1)</text></g><g class="message" data-participant-1="MS" data-participant-2="MS"><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="844.9028" y1="3148.8604" y2="3148.8604"/><line style="stroke:#000000;stroke-width:1;" x1="844.9028" x2="844.9028" y1="3148.8604" y2="3161.8604"/><line style="stroke:#000000;stroke-width:1;" x1="803.9028" x2="844.9028" y1="3161.8604" y2="3161.8604"/><polygon fill="#000000" points="813.9028,3157.8604,803.9028,3161.8604,813.9028,3165.8604,809.9028,3161.8604" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="180.2417" x="809.9028" y="3144.1309">Thread 1: Process message</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,3206.459,1122.373,3210.459,1112.373,3214.459,1116.373,3210.459" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="3210.459" y2="3210.459"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="187.0273" x="809.9028" y="3189.9302">Thread 1: INSERT messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="227.043" x="809.9028" y="3205.7295">(idempotencyKey: msg_race_999)</text></g><path d="M1129,3174.8604 L1129,3215.8604 L1340,3215.8604 L1340,3184.8604 L1330,3174.8604 L1129,3174.8604" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M1330,3174.8604 L1330,3184.8604 L1340,3184.8604 L1330,3174.8604" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="120.9102" x="1135" y="3192.9302">Unique constraint:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="190.4741" x="1135" y="3208.7295">(sessionId, idempotencyKey)</text><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="813.9028,3239.2583,803.9028,3243.2583,813.9028,3247.2583,809.9028,3243.2583" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="807.9028" x2="1123.373" y1="3243.2583" y2="3243.2583"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="178.4009" x="819.9028" y="3238.5288">Thread 1: Insert successful</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,3269.0576,1122.373,3273.0576,1112.373,3277.0576,1116.373,3273.0576" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="3273.0576" y2="3273.0576"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="208.0698" x="809.9028" y="3268.3281">Thread 1: Complete transaction</text></g><g class="message" data-participant-1="MS" data-participant-2="MS"><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="844.9028" y1="3302.8569" y2="3302.8569"/><line style="stroke:#000000;stroke-width:1;" x1="844.9028" x2="844.9028" y1="3302.8569" y2="3315.8569"/><line style="stroke:#000000;stroke-width:1;" x1="803.9028" x2="844.9028" y1="3315.8569" y2="3315.8569"/><polygon fill="#000000" points="813.9028,3311.8569,803.9028,3315.8569,813.9028,3319.8569,809.9028,3315.8569" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="149.6587" x="809.9028" y="3298.1274">Thread 1: Release lock</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="813.9028,3357.4556,803.9028,3361.4556,813.9028,3365.4556,809.9028,3361.4556" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="807.9028" x2="1123.373" y1="3361.4556" y2="3361.4556"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="158.7739" x="819.9028" y="3340.9268">Thread 2: Lock acquired</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="129.6763" x="819.9028" y="3356.7261">(Thread 1 released)</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,3403.0542,1122.373,3407.0542,1112.373,3411.0542,1116.373,3407.0542" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="3407.0542" y2="3407.0542"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="132.5835" x="809.9028" y="3386.5254">Thread 2: SELECT...</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="284.1973" x="809.9028" y="3402.3247">WHERE idempotencyKey = 'msg_race_999'</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="813.9028,3448.6528,803.9028,3452.6528,813.9028,3456.6528,809.9028,3452.6528" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="807.9028" x2="1123.373" y1="3452.6528" y2="3452.6528"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="171.3423" x="819.9028" y="3432.124">Thread 2: Message found!</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="147.8369" x="819.9028" y="3447.9233">(inserted by Thread 1)</text></g><g class="message" data-participant-1="MS" data-participant-2="MS"><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="844.9028" y1="3482.4521" y2="3482.4521"/><line style="stroke:#000000;stroke-width:1;" x1="844.9028" x2="844.9028" y1="3482.4521" y2="3495.4521"/><line style="stroke:#000000;stroke-width:1;" x1="803.9028" x2="844.9028" y1="3495.4521" y2="3495.4521"/><polygon fill="#000000" points="813.9028,3491.4521,803.9028,3495.4521,813.9028,3499.4521,809.9028,3495.4521" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="226.0146" x="809.9028" y="3477.7227">Thread 2: Return cached response</text></g><g class="message" data-participant-1="MS" data-participant-2="API"><polygon fill="#000000" points="551.688,3521.2515,541.688,3525.2515,551.688,3529.2515,547.688,3525.2515" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="545.688" x2="801.9028" y1="3525.2515" y2="3525.2515"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="182.73" x="557.688" y="3520.522">Thread 1: Original response</text></g><g class="message" data-participant-1="MS" data-participant-2="API"><polygon fill="#000000" points="551.688,3551.0508,541.688,3555.0508,551.688,3559.0508,547.688,3555.0508" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="545.688" x2="801.9028" y1="3555.0508" y2="3555.0508"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="179.8418" x="557.688" y="3550.3213">Thread 2: Cached response</text></g><g class="message" data-participant-1="API" data-participant-2="C1"><polygon fill="#000000" points="1316.4131,3580.8501,1326.4131,3584.8501,1316.4131,3588.8501,1320.4131,3584.8501" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="540.688" x2="1322.4131" y1="3584.8501" y2="3584.8501"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="130.4253" x="547.688" y="3580.1206">200 OK (processed)</text></g><g class="message" data-participant-1="API" data-participant-2="C2"><polygon fill="#000000" points="1423.167,3610.6494,1433.167,3614.6494,1423.167,3618.6494,1427.167,3614.6494" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="540.688" x2="1429.167" y1="3614.6494" y2="3614.6494"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="110.4048" x="547.688" y="3609.9199">200 OK (cached)</text></g><path d="M1440,3627.6494 L1440,3668.6494 L1673,3668.6494 L1673,3637.6494 L1663,3627.6494 L1440,3627.6494" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M1663,3627.6494 L1663,3637.6494 L1673,3637.6494 L1663,3627.6494" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="212.9956" x="1446" y="3645.7192">Thread 2 gets identical response</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="160.3735" x="1446" y="3661.5186">No duplicate processing!</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1688.9956" x="5" y="3702.1477"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1693.9956" y1="3702.1477" y2="3702.1477"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1693.9956" y1="3705.1477" y2="3705.1477"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="295.0234" x="701.9861" y="3691.248"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="276.5801" x="707.9861" y="3708.3179">Key Expiration (Future Enhancement)</text><path d="M634,3730.0474 L634,3992.0474 L971,3992.0474 L971,3740.0474 L961,3730.0474 L634,3730.0474" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M961,3730.0474 L961,3740.0474 L971,3740.0474 L961,3730.0474" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="110.9888" x="640" y="3748.1172">Current (MVP):</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="117.7109" x="640" y="3763.9165">Keys never expire</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="147.2085" x="640" y="3779.7158">Messages kept forever</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="4.5703" x="640" y="3795.5151">&#160;</text><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="151.2646" x="640" y="3811.3145">Future (Production):</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="152.8643" x="640" y="3827.1138">&#8226; TTL: 24 hours default</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="218.772" x="640" y="3842.9131">&#8226; Cleanup job: DELETE messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="307.4995" x="649.1406" y="3858.7124">WHERE createdAt &lt; now() - interval '24 hours'</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="230.9976" x="649.1406" y="3874.5117">AND idempotencyKey IS NOT NULL</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="281.8359" x="640" y="3890.311">&#8226; After expiration, same key can be reused</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="276.6309" x="640" y="3906.1104">&#8226; Client should use timestamp-based keys</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="4.5703" x="640" y="3921.9097">&#160;</text><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="109.4019" x="640" y="3937.709">Why 24 hours?</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="258.978" x="640" y="3953.5083">&#8226; Long enough for any reasonable retry</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="248.7329" x="640" y="3969.3076">&#8226; Short enough to avoid accumulation</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="251.6973" x="640" y="3985.1069">&#8226; Matches typical HTTP client timeouts</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1688.9956" x="5" y="4018.7361"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1693.9956" y1="4018.7361" y2="4018.7361"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1693.9956" y1="4021.7361" y2="4021.7361"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="148.3037" x="775.3459" y="4007.8364"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="129.8604" x="781.3459" y="4024.9063">Database Schema</text><path d="M942,4046.6357 L942,4529.6357 L1305,4529.6357 L1305,4056.6357 L1295,4046.6357 L942,4046.6357" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M1295,4046.6357 L1295,4056.6357 L1305,4056.6357 L1295,4046.6357" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="43.2339" x="948" y="4064.7056">```sql</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="176.6934" x="948" y="4080.5049">CREATE TABLE messages (</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="208.4951" x="957.1406" y="4096.3042">id              UUID PRIMARY KEY,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="203.3789" x="957.1406" y="4112.1035">sessionId       UUID NOT NULL,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="222.1045" x="957.1406" y="4127.9028">idempotencyKey  VARCHAR(255),</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="247.0635" x="957.1406" y="4143.7021">role            VARCHAR(20) NOT NULL,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="198.9355" x="957.1406" y="4159.5015">content         TEXT NOT NULL,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="256.7754" x="957.1406" y="4175.3008">sequenceNumber  INTEGER NOT NULL,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="283.8672" x="957.1406" y="4191.1001">createdAt       TIMESTAMP DEFAULT now(),</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="4.5703" x="948" y="4206.8994">&#160;</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="263.2563" x="957.1406" y="4222.6987">-- Unique constraint prevents duplicates</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="258.9907" x="957.1406" y="4238.498">CONSTRAINT unique_idempotency_key</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="252.4526" x="966.2813" y="4254.2974">UNIQUE (sessionId, idempotencyKey),</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="4.5703" x="948" y="4270.0967">&#160;</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="231.2197" x="957.1406" y="4285.896">-- Composite index for fast lookups</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="230.7627" x="957.1406" y="4301.6953">INDEX idx_messages_idempotency</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="144.3838" x="966.2813" y="4317.4946">ON (idempotencyKey)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="255.2012" x="966.2813" y="4333.2939">WHERE idempotencyKey IS NOT NULL,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="4.5703" x="948" y="4349.0933">&#160;</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="264.5132" x="957.1406" y="4364.8926">-- Sequence must be unique per session</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="205.3213" x="957.1406" y="4380.6919">CONSTRAINT unique_sequence</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="252.9922" x="966.2813" y="4396.4912">UNIQUE (sessionId, sequenceNumber)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="11.8066" x="948" y="4412.2905">);</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="24.7939" x="948" y="4428.0898">```</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="4.5703" x="948" y="4443.8892">&#160;</text><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="82.583" x="948" y="4459.6885">Key Points:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="258.5464" x="948" y="4475.4878">&#8226; idempotencyKey is optional (nullable)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="342.3989" x="948" y="4491.2871">&#8226; Unique constraint on (sessionId, idempotencyKey)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="281.563" x="948" y="4507.0864">&#8226; Index on idempotencyKey for fast lookup</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="210.2725" x="948" y="4522.8857">&#8226; Scoped to session (not global)</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1688.9956" x="5" y="4556.5149"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1693.9956" y1="4556.5149" y2="4556.5149"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1693.9956" y1="4559.5149" y2="4559.5149"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="168.2925" x="765.3516" y="4545.6152"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="149.8491" x="771.3516" y="4562.6851">Client Best Practices</text><path d="M10,4584.4146 L10,5067.4146 L483,5067.4146 L483,4594.4146 L473,4584.4146 L10,4584.4146" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M473,4584.4146 L473,4594.4146 L483,4594.4146 L473,4584.4146" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="226.3955" x="16" y="4602.4844">Generating Idempotency Keys:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="4.5703" x="16" y="4618.2837">&#160;</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="89.3369" x="16" y="4634.083">```typescript</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="204.4644" x="16" y="4649.8823">// Option 1: UUID v4 (random)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="228.9727" x="16" y="4665.6816">const idempotencyKey = uuidv4();</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="304.8018" x="16" y="4681.481">// "f47ac10b-58cc-4372-a567-0e02b2c3d479"</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="4.5703" x="16" y="4697.2803">&#160;</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="209.5361" x="16" y="4713.0796">// Option 2: Timestamp + UUID</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="413.0674" x="16" y="4728.8789">const idempotencyKey = `msg_${Date.now()}_${uuidv4()}`;</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="254.2935" x="16" y="4744.6782">// "msg_1705324800000_f47ac10b..."</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="4.5703" x="16" y="4760.4775">&#160;</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="186.1069" x="16" y="4776.2769">// Option 3: Hash of content</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="452.0039" x="16" y="4792.0762">const idempotencyKey = sha256(sessionId + content + timestamp);</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="202.7251" x="16" y="4807.8755">// Deterministic for same input</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="4.5703" x="16" y="4823.6748">&#160;</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="172.0605" x="16" y="4839.4741">// &#10060; BAD: Sequential IDs</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="303.7861" x="16" y="4855.2734">const idempotencyKey = messageCounter++;</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="209.3521" x="16" y="4871.0728">// Risk of collision across clients</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="24.7939" x="16" y="4886.8721">```</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="4.5703" x="16" y="4902.6714">&#160;</text><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="97.6904" x="16" y="4918.4707">When to Use:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="208.4009" x="16" y="4934.27">&#9989; All message send operations</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="196.4863" x="16" y="4950.0693">&#9989; Payment/billing operations</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="262.5273" x="16" y="4965.8687">&#9989; Resource creation (agents, sessions)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="194.4233" x="16" y="4981.668">&#9989; State-changing operations</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="4.5703" x="16" y="4997.4673">&#160;</text><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="133.0532" x="16" y="5013.2666">When NOT to Use:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="224.4351" x="16" y="5029.0659">&#10060; Read operations (GET /agents)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="284.8076" x="16" y="5044.8652">&#10060; Idempotent by nature (PUT /agents/:id)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="183.0103" x="16" y="5060.6646">&#10060; Search/query operations</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="1688.9956" x="5" y="5094.2937"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1693.9956" y1="5094.2937" y2="5094.2937"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1693.9956" y1="5097.2937" y2="5097.2937"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="125.2363" x="786.8796" y="5083.394"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="106.793" x="792.8796" y="5100.4639">Error Handling</text><g class="message" data-participant-1="Client" data-participant-2="API"><polygon fill="#000000" points="528.688,5134.9927,538.688,5138.9927,528.688,5142.9927,532.688,5138.9927" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="246.0874" x2="534.688" y1="5138.9927" y2="5138.9927"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="206.3877" x="253.0874" y="5134.2632">POST with key: msg_error_456</text></g><g class="message" data-participant-1="API" data-participant-2="MS"><polygon fill="#000000" points="790.9028,5164.792,800.9028,5168.792,790.9028,5172.792,794.9028,5168.792" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="540.688" x2="796.9028" y1="5168.792" y2="5168.792"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="105.498" x="547.688" y="5164.0625">processMessage</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,5194.5913,1122.373,5198.5913,1112.373,5202.5913,1116.373,5198.5913" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="5198.5913" y2="5198.5913"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="191.4136" x="809.9028" y="5193.8618">SELECT (idempotency check)</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="813.9028,5224.3906,803.9028,5228.3906,813.9028,5232.3906,809.9028,5228.3906" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="807.9028" x2="1123.373" y1="5228.3906" y2="5228.3906"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="64.3208" x="819.9028" y="5223.6611">Not found</text></g><g class="message" data-participant-1="MS" data-participant-2="MS"><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="844.9028" y1="5258.1899" y2="5258.1899"/><line style="stroke:#000000;stroke-width:1;" x1="844.9028" x2="844.9028" y1="5258.1899" y2="5271.1899"/><line style="stroke:#000000;stroke-width:1;" x1="803.9028" x2="844.9028" y1="5271.1899" y2="5271.1899"/><polygon fill="#000000" points="813.9028,5267.1899,803.9028,5271.1899,813.9028,5275.1899,809.9028,5271.1899" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="79.3394" x="809.9028" y="5253.4604">Acquire lock</text></g><g class="message" data-participant-1="MS" data-participant-2="PRV"><polygon fill="#000000" points="1211.9971,5296.9893,1221.9971,5300.9893,1211.9971,5304.9893,1215.9971,5300.9893" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1217.9971" y1="5300.9893" y2="5300.9893"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="82.7798" x="809.9028" y="5296.2598">Call provider</text></g><g class="message" data-participant-1="PRV" data-participant-2="MS"><polygon fill="#000000" points="813.9028,5326.7886,803.9028,5330.7886,813.9028,5334.7886,809.9028,5330.7886" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="807.9028" x2="1222.9971" y1="5330.7886" y2="5330.7886"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="167.21" x="819.9028" y="5326.0591">Error (timeout, 500, etc.)</text></g><g class="message" data-participant-1="MS" data-participant-2="MS"><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="844.9028" y1="5360.5879" y2="5360.5879"/><line style="stroke:#000000;stroke-width:1;" x1="844.9028" x2="844.9028" y1="5360.5879" y2="5373.5879"/><line style="stroke:#000000;stroke-width:1;" x1="803.9028" x2="844.9028" y1="5373.5879" y2="5373.5879"/><polygon fill="#000000" points="813.9028,5369.5879,803.9028,5373.5879,813.9028,5377.5879,809.9028,5373.5879" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="80.9136" x="809.9028" y="5355.8584">Release lock</text></g><g class="message" data-participant-1="MS" data-participant-2="API"><polygon fill="#000000" points="551.688,5494.1831,541.688,5498.1831,551.688,5502.1831,547.688,5498.1831" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="545.688" x2="801.9028" y1="5498.1831" y2="5498.1831"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="96.1226" x="557.688" y="5398.6577">Error response</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="557.688" y="5414.457">{</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="62.937" x="566.8286" y="5430.2563">"error": {</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="192.1563" x="575.9692" y="5446.0557">"code": "PROVIDER_ERROR",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="219.9336" x="575.9692" y="5461.855">"message": "AI provider timeout"</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="566.8286" y="5477.6543">}</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.252" x="557.688" y="5493.4536">}</text></g><g class="message" data-participant-1="API" data-participant-2="Client"><polygon fill="#000000" points="257.0874,5523.9824,247.0874,5527.9824,257.0874,5531.9824,253.0874,5527.9824" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="251.0874" x2="539.688" y1="5527.9824" y2="5527.9824"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="115.6479" x="263.0874" y="5523.2529">502 Bad Gateway</text></g><path d="M251,5540.9824 L251,5660.9824 L471,5660.9824 L471,5550.9824 L461,5540.9824 L251,5540.9824" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M461,5540.9824 L461,5550.9824 L471,5550.9824 L461,5540.9824" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="153.3657" x="257" y="5559.0522">Error Retry Strategy:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="199.5195" x="257" y="5574.8516">1. Provider error: safe to retry</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="184.9517" x="270.7109" y="5590.6509">with SAME idempotency key</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="172.8721" x="257" y="5606.4502">2. Retry will process again</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="185.6689" x="270.7109" y="5622.2495">(no cached result for errors)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="195.4063" x="257" y="5638.0488">3. If retry succeeds, response</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="173.5386" x="270.7109" y="5653.8481">is cached for future retries</text><g class="message" data-participant-1="Client" data-participant-2="API"><polygon fill="#000000" points="528.688,5700.1763,538.688,5704.1763,528.688,5708.1763,532.688,5704.1763" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="246.0874" x2="534.688" y1="5704.1763" y2="5704.1763"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="142.397" x="253.0874" y="5683.6475">Retry with SAME key:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="101.1182" x="253.0874" y="5699.4468">msg_error_456</text></g><g class="message" data-participant-1="API" data-participant-2="MS"><polygon fill="#000000" points="790.9028,5729.9756,800.9028,5733.9756,790.9028,5737.9756,794.9028,5733.9756" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="540.688" x2="796.9028" y1="5733.9756" y2="5733.9756"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="105.498" x="547.688" y="5729.2461">processMessage</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,5759.7749,1122.373,5763.7749,1112.373,5767.7749,1116.373,5763.7749" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="5763.7749" y2="5763.7749"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="191.4136" x="809.9028" y="5759.0454">SELECT (idempotency check)</text></g><g class="message" data-participant-1="DB" data-participant-2="MS"><polygon fill="#000000" points="813.9028,5805.3735,803.9028,5809.3735,813.9028,5813.3735,809.9028,5809.3735" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="807.9028" x2="1123.373" y1="5809.3735" y2="5809.3735"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="64.3208" x="819.9028" y="5788.8447">Not found</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="126.6611" x="819.9028" y="5804.644">(errors not cached)</text></g><g class="message" data-participant-1="MS" data-participant-2="MS"><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="844.9028" y1="5839.1729" y2="5839.1729"/><line style="stroke:#000000;stroke-width:1;" x1="844.9028" x2="844.9028" y1="5839.1729" y2="5852.1729"/><line style="stroke:#000000;stroke-width:1;" x1="803.9028" x2="844.9028" y1="5852.1729" y2="5852.1729"/><polygon fill="#000000" points="813.9028,5848.1729,803.9028,5852.1729,813.9028,5856.1729,809.9028,5852.1729" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="103.6064" x="809.9028" y="5834.4434">Process again...</text></g><g class="message" data-participant-1="PRV" data-participant-2="MS"><polygon fill="#000000" points="813.9028,5877.9722,803.9028,5881.9722,813.9028,5885.9722,809.9028,5881.9722" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="807.9028" x2="1222.9971" y1="5881.9722" y2="5881.9722"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="125.6646" x="819.9028" y="5877.2427">Success (this time)</text></g><g class="message" data-participant-1="MS" data-participant-2="DB"><polygon fill="#000000" points="1112.373,5923.5708,1122.373,5927.5708,1112.373,5931.5708,1116.373,5927.5708" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="802.9028" x2="1118.373" y1="5927.5708" y2="5927.5708"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="81.4785" x="809.9028" y="5907.042">INSERT with</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="219.6416" x="809.9028" y="5922.8413">idempotencyKey: msg_error_456</text></g><g class="message" data-participant-1="MS" data-participant-2="API"><polygon fill="#000000" points="551.688,5953.3701,541.688,5957.3701,551.688,5961.3701,547.688,5957.3701" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="545.688" x2="801.9028" y1="5957.3701" y2="5957.3701"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="115.3179" x="557.688" y="5952.6406">Success response</text></g><g class="message" data-participant-1="API" data-participant-2="Client"><polygon fill="#000000" points="257.0874,5983.1694,247.0874,5987.1694,257.0874,5991.1694,253.0874,5987.1694" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="251.0874" x2="539.688" y1="5987.1694" y2="5987.1694"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="48.604" x="263.0874" y="5982.4399">200 OK</text></g><path d="M251,6000.1694 L251,6057.1694 L463,6057.1694 L463,6010.1694 L453,6000.1694 L251,6000.1694" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M453,6000.1694 L453,6010.1694 L463,6010.1694 L453,6000.1694" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="134.5132" x="257" y="6018.2393">Retry with same key</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="146.1484" x="257" y="6034.0386">processes successfully</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="191.4517" x="257" y="6049.8379">Now cached for future retries</text><!--SRC=[rLdBSjlA4TtZAzgygH8fatfGacKpSMvH92qp5XyNfFoeKfKy14Oa8X2WCGF9B9Uhiiakdv1iycdtIz8zWy6311KdYrIkl34nZUwUdjEdUnhFv88lEQnyvWMMkFU25OlO4cRCkPz7OHoudT0F8_ZfJO_-MPRqfC-Xx_BbAfGySDRGW7747tWWlM0EtNZbUmwJ70PS23Rdk1Ww-5zSj2pcIDJLyJsKjj2Gz1nlnG89bVQu3vVusYDRLu09mDz50QDkmgC7p-5AQ32nN2RPZ0aEbN4ev3pYar-kr5htelW-kl7WkJnIYsFxlMMzVWrll4X8iFcNc0lPWY5_JDr-_TgojAFG-2EvquBnQ3A5Gq6R2GDnsFBSmwMM5ZV1nqOk9ertVDs2fPZVne67oc-FcoUdPpV1jvi0eEA40Kh9IWig7nPCWYTWkOOmGkz0I2PZyNFb9lXkMG5gWyYRBoI4ToPiYLDp7l080oP0cu1xlhQgrzVzRXsaXtv9jbmrA3Hk7RXq3ceM3rmWbPP5qSPT3IOjMEdZIRPTlGcI_VNT-asGU8h_yxBDuTvkWffb3IQaetlHWadlgjUPmZwyiKS3o6BouMtFxa6g45x3ppT1UzY5eZPylhSPgptBwbv08t5o648KFWgu8q1knWLHG4hmeLvlWLnWI3rXCGZuOzq4ADB7d0k3tW4PK23bBZnwSc52eX2RRRBjV8czY9ljW1ywzpT1TQMnBm1ZvSHHH6UJAQZbZLo5p2Mn1nu99ac7YkzNYMeIhNN0o6700NU0gR9EtqV4jg33V1_QVTAli8plAOVlOdoUwC8tK3QD74f7NAmGhpo_cKikCJPV9Uu6Wn8u789uEUDHFkXcQQXMy93EyXekUfVz8Kpjzd3Ixapxes5-iJ-SzEnf3WdL35KRXu_OYaAVj-0QNwb3XhYY-HQSrV87RrthGqLv8IFaBeH2OEqsKxFIWt8DHGd0vCCD-xZWRy7Yt-v3kzsUJFgJQNiupQKBRFh-0XVDeT4XzjrQYHaZSUkW21bpGiIJhw121iqwAfFXFGz47_6Y_pUAoQhYZZBDCRb_g_UFUj59vCIyIktKBiKEKck7tYtexem6W_wq284SVDg8oOZZ5bpAZUNIavAx-NImkS-9kVC9fTSDuTe9SXFYJ8v1-GavfD2AP5G9Ml3juE3Wko9FnN6eIVDb2vf7Hp1wPpZOSub-YNNOpBazV_cgeXHLw51f9JtMv7cEip-5SPImzK-Agz1a8cNygEGTmJgJLSMqrapOibX65H6-JZ0U8aSOmXzo-HX6zp3tFUaiq38ukWH4N4Phos4nHZ13jU4vnMNMf3tevLD1bOaCwl-N5QxKPwpQbC5U68iI9l-j5JJJPQY2zIm9c-UMGLBJp2OWauqy2SUoh2WjdSMo2SpQ0bDfqRIvZ2CiOinPOEcCqcIjkc6mbrP1h6X8pyzg9RRtzpjsVzhljAzQ-_lMht_v9nLwGqb0B6WUpZpVftgS_CIodfwAUlQdMAXy87z2DE45pCyANz5v0_REfj-_PP9vgbL45kRU0t84XXMxT2SV6Wmcjjn8zY0v4hOdzqHoe5OLwseWi8ac7Jc0vnj9vBPErlSav2OG6WnR2bnnFTNd4AyLkd7jsKqmNKGScw9ZrPLtZfyKQcgX9hBMSP6nL1DqRmWfGjkthrwziZhD7n53l2u9NG9hLO2r2kijZse57ZwkazcB45zFyW5H7KKOKqGYY_or9Rnbx4iMSAGdVwqj2MBu8jtcQChiV9EmIcIQMp8vgihqQD92H1YUAYSbi- -zRIND_q99djKoNuQc6IzPRkQNjqb1XLagKO5KYpUxjBElM0fNZi7LizAcBVEYh6N7IwWlKncyHk5PqdEuexkW1VXNkgChac5Q8RfDScNncqPh8vMOAzVOJ3G-Ca-gQ5Td98vyD5kdLcjvEqLtabkreQiT3XsNjR354oqcGs8nrsVJpwrUkwKUFzLjqtfsE3kZsaSEYl0M4Zkq6xp7xDv89rokV8v-ALfY3W5WTtnCS_aZPs1E5MEJuYBIxxkrtKVzdwVAJZSssu6gf-BoOsXexgh4cRoXmIm-ewqYkKEskLKejTgqyXsRgWVLXAKeQWMHPYQYNTo2cIfQJVNGsDMfMLAoI0ZBLjQZPDVjPqNSSI8OB55q6hslAo_Ij-xgcnZ3nQ4NB1XUqfPeeRRHUklc92bhrS7xSOqw5DGZaF59W9CwRYK79v3dLqHITCUCB7mtCL75F7LZXTMQwN6cqokCnoaiiCHZtyxl69OEjT91p0Nn2luSpbhGHNXDUrcR0w1Hvc1u41bj2N_0NJvMQz00J4aUFM2GzepUFPGlQKpx4nYEfZ2ylhfI5jjtqcn6nQQULYq4Km0pQW3nUk4cxgbsGg01tyKx9TySDD5xWdR_OR5ET_XpikshC9ZZqOJnV4610XQiKJaJOS1cFaykCoGuMOH82OaaDYRi8VHSJ58dnXghl5HY0uQt8OoyNAyKFjvEfsDpCoA_mbYAOgVIDRF22RwuP1j7thsmFd_-BBxuLiVkjJ7oq_R5LHP_g5hKeKFXZyPjCBRxWxRz2TxrFjLH9hiTv6HCqEjAIU58u7tRxhnjszNcsLcDrgaxp1j9ruzg1Jr9jvZAJNiVfmM1ZG4Ebe9fxx9d5vMaQ4gKz0SzR4a7OyJVc_RrrLHZh4u9ssXiLm8e6QkWQ6Sqd4pjDbfCfc-tkLtVKbEaGZFi_tBTUwgE6Bj4_g7myAoymELV5O3k6FRyVXZUnoiosHzsUn_n_Q-tviZoDfMzqH2gPOMgbBvpgMAyc9XXsPAk6vWSoMHnHTTQlOVIlPk3sBNfua7LhDhl2OgKIEJ8ECGu2yCU6rxYTIrSKKvW1bI3sFSfcMfAicn2zcJDffVwAhmek65d8-0wKPrmXKcFAMeQh2grQdC_d35_yvQW4_E21XFZYAetKdRvl6D__rBFjkbxmiQ4H8M1WeDPpuKJUIjf7Hx2I8M0wfhAjeTJg6AJu8RBcgMslrsQuzXp7qwh66bylN9tUiwSuwDPu-obupHEJywR3NRsuhnnn8-QiwPpufwUlwfOEKlKwHdkW-VAwYvBdwa9-Dqt91z-e7BfE_uovhz_rWwGpF7vqTb9y_Jb4VtT6fVetfUtVDA2jqmig60c1B3Bi5YmvjcBxC3HJqCPppFcrX7eOcCLBRt04tWmwh1L7V22LIoLzL__yJUuQ7TRIGv83_7MxufTjfCKx60_WugVFrT6R4_SQx_fkaMROKuKOXEhMLiOq7zOy81GTIsuGltV_wg6YObE11i22v6dAvPGwsEsfZ9-cCm9DfTjBh0KqTM1w4uXLStPHTr0LzIKu4JYCJKSx0lc6sgCNyG9ETymB3QrAvaaL2zxKpZK-cjA8WMnf7ukO4bhS9sAqQHDYqxmFkai3Z76U978cIyaKo-Ay8JU8iBLPdTzgYhUTpczT7jwzkA9QLd932nFc81rqxcl5R_Cf3Uvh35j5ov0cnymp82d-A52xwcQLEuwd1qTcUzM9JFZxLcnVdzZc5DHcwP12VrI4nPNJLx6zkXzlzkpRtksFRBrO4MDLbGOr6mc-ynYseaAIPNFVSwEcd21C4W-OUwOn-plQozjwdKGQ_JzRhuc71qVWFb02Shd5YRW7IUawSO8lLF7MJeRRHuaAXyz7TzixaOl8YldhWRORAe4LsOGe2S7qB_JLlGzZBkO5lbkspCZ8Lq5T6TBBtXSx9ub6u-CqmJ4c-1_W4IyFkczgK-2wOLZusEV2H3oQn684tqNHIZIE9IElkoB2krhSuYybMTvV1grsIsgV7Qu0pgvQAPp9NFT4hdxix-sXk7ZZvpNlm00]--></g></svg>