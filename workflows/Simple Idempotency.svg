<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="1146px" preserveAspectRatio="none" style="width:734px;height:1146px;background:#FEFEFE;" version="1.1" viewBox="0 0 734 1146" width="734px" zoomAndPan="magnify"><title>Idempotency - Simplified</title><defs/><g><rect fill="#FEFEFE" height="1146" style="stroke:none;stroke-width:1;" width="734" x="0" y="0"/><text fill="#000000" font-family="Verdana" font-size="22" font-weight="bold" lengthAdjust="spacing" textLength="312.5869" x="209.3701" y="37.1182">Idempotency - Simplified</text><g><title>Client</title><rect fill="#000000" fill-opacity="0.00000" height="739.3809" width="8" x="29.0874" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="33" x2="33" y1="130.752" y2="870.1328"/></g><g><title>API</title><rect fill="#000000" fill-opacity="0.00000" height="739.3809" width="8" x="271.3325" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="274.3799" x2="274.3799" y1="130.752" y2="870.1328"/></g><g><title>Database</title><rect fill="#000000" fill-opacity="0.00000" height="739.3809" width="8" x="559.9219" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="562.9795" x2="562.9795" y1="130.752" y2="870.1328"/></g><g><title>AI Provider</title><rect fill="#000000" fill-opacity="0.00000" height="739.3809" width="8" x="662.0957" y="130.752"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="665.8643" x2="665.8643" y1="130.752" y2="870.1328"/></g><g class="participant participant-head" data-participant="Client"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="40.1748" x="10" y="127.8125">Client</text><ellipse cx="33.0874" cy="61.7373" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1;"/><path d="M33.0874,69.7373 L33.0874,96.7373 M20.0874,77.7373 L46.0874,77.7373 M33.0874,96.7373 L20.0874,111.7373 M33.0874,96.7373 L46.0874,111.7373" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-tail" data-participant="Client"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="40.1748" x="10" y="883.208">Client</text><ellipse cx="33.0874" cy="895.1475" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1;"/><path d="M33.0874,903.1475 L33.0874,930.1475 M20.0874,911.1475 L46.0874,911.1475 M33.0874,930.1475 L20.0874,945.1475 M33.0874,930.1475 L46.0874,945.1475" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-head" data-participant="API"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="37.9053" x="256.3799" y="98.7373"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="23.9053" x="263.3799" y="119.8125">API</text></g><g class="participant participant-tail" data-participant="API"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="37.9053" x="256.3799" y="869.1328"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="23.9053" x="263.3799" y="890.208">API</text></g><g class="participant participant-head" data-participant="DB"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="65.8848" x="527.9795" y="127.8125">Database</text><path d="M545.9219,77.7373 C545.9219,67.7373 563.9219,67.7373 563.9219,67.7373 C563.9219,67.7373 581.9219,67.7373 581.9219,77.7373 L581.9219,103.7373 C581.9219,113.7373 563.9219,113.7373 563.9219,113.7373 C563.9219,113.7373 545.9219,113.7373 545.9219,103.7373 L545.9219,77.7373" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M545.9219,77.7373 C545.9219,87.7373 563.9219,87.7373 563.9219,87.7373 C563.9219,87.7373 581.9219,87.7373 581.9219,77.7373" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-tail" data-participant="DB"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="65.8848" x="527.9795" y="883.208">Database</text><path d="M545.9219,896.1475 C545.9219,886.1475 563.9219,886.1475 563.9219,886.1475 C563.9219,886.1475 581.9219,886.1475 581.9219,896.1475 L581.9219,922.1475 C581.9219,932.1475 563.9219,932.1475 563.9219,932.1475 C563.9219,932.1475 545.9219,932.1475 545.9219,922.1475 L545.9219,896.1475" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M545.9219,896.1475 C545.9219,906.1475 563.9219,906.1475 563.9219,906.1475 C563.9219,906.1475 581.9219,906.1475 581.9219,896.1475" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-head" data-participant="AI"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="92.4629" x="619.8643" y="98.7373"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="78.4629" x="626.8643" y="119.8125">AI Provider</text></g><g class="participant participant-tail" data-participant="AI"><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="92.4629" x="619.8643" y="869.1328"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="78.4629" x="626.8643" y="890.208">AI Provider</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="722.3271" x="5" y="161.6516"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="727.3271" y1="161.6516" y2="161.6516"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="727.3271" y1="164.6516" y2="164.6516"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="166.2485" x="283.0393" y="150.752"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="147.8052" x="289.0393" y="167.8218">First Request (New)</text><g class="message" data-participant-1="Client" data-participant-2="API"><polygon fill="#000000" points="263.3325,218.1499,273.3325,222.1499,263.3325,226.1499,267.3325,222.1499" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="33.0874" x2="269.3325" y1="222.1499" y2="222.1499"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="109.8018" x="40.0874" y="201.6211">POST /messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="218.2451" x="40.0874" y="217.4204">X-Idempotency-Key: msg_12345</text></g><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#000000" points="551.9219,263.7485,561.9219,267.7485,551.9219,271.7485,555.9219,267.7485" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="275.3325" x2="557.9219" y1="267.7485" y2="267.7485"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="161.7954" x="282.3325" y="247.2197">Check: SELECT message</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="264.5894" x="282.3325" y="263.019">WHERE idempotencyKey = 'msg_12345'</text></g><g class="message" data-participant-1="DB" data-participant-2="API"><polygon fill="#000000" points="286.3325,293.5479,276.3325,297.5479,286.3325,301.5479,282.3325,297.5479" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="280.3325" x2="562.9219" y1="297.5479" y2="297.5479"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="64.3208" x="292.3325" y="292.8184">Not found</text></g><g class="message" data-participant-1="API" data-participant-2="API"><line style="stroke:#000000;stroke-width:1;" x1="275.3325" x2="317.3325" y1="327.3472" y2="327.3472"/><line style="stroke:#000000;stroke-width:1;" x1="317.3325" x2="317.3325" y1="327.3472" y2="340.3472"/><line style="stroke:#000000;stroke-width:1;" x1="276.3325" x2="317.3325" y1="340.3472" y2="340.3472"/><polygon fill="#000000" points="286.3325,336.3472,276.3325,340.3472,286.3325,344.3472,282.3325,340.3472" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="125.6836" x="282.3325" y="322.6177">Process message...</text></g><g class="message" data-participant-1="API" data-participant-2="AI"><polygon fill="#000000" points="654.0957,366.1465,664.0957,370.1465,654.0957,374.1465,658.0957,370.1465" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="275.3325" x2="660.0957" y1="370.1465" y2="370.1465"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="101.7085" x="282.3325" y="365.417">Call AI provider</text></g><g class="message" data-participant-1="AI" data-participant-2="API"><polygon fill="#000000" points="286.3325,395.9458,276.3325,399.9458,286.3325,403.9458,282.3325,399.9458" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="280.3325" x2="665.0957" y1="399.9458" y2="399.9458"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="62.2896" x="292.3325" y="395.2163">Response</text></g><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#000000" points="551.9219,441.5444,561.9219,445.5444,551.9219,449.5444,555.9219,445.5444" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="275.3325" x2="557.9219" y1="445.5444" y2="445.5444"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="97.3477" x="282.3325" y="425.0156">Store message</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="252.5923" x="282.3325" y="440.8149">WITH idempotencyKey = 'msg_12345'</text></g><g class="message" data-participant-1="API" data-participant-2="Client"><polygon fill="#000000" points="44.0874,471.3438,34.0874,475.3438,44.0874,479.3438,40.0874,475.3438" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="38.0874" x2="274.3325" y1="475.3438" y2="475.3438"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="128.4766" x="50.0874" y="470.6143">200 OK {response}</text></g><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1;" width="722.3271" x="5" y="504.2434"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="727.3271" y1="504.2434" y2="504.2434"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="727.3271" y1="507.2434" y2="507.2434"/><rect fill="#FFFFFF" height="23.7993" style="stroke:#000000;stroke-width:1;" width="222.5903" x="254.8684" y="493.3438"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="204.147" x="260.8684" y="510.4136">Second Request (Duplicate)</text><g class="message" data-participant-1="Client" data-participant-2="API"><polygon fill="#000000" points="263.3325,576.541,273.3325,580.541,263.3325,584.541,267.3325,580.541" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="33.0874" x2="269.3325" y1="580.541" y2="580.541"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="109.8018" x="40.0874" y="544.2129">POST /messages</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="218.2451" x="40.0874" y="560.0122">X-Idempotency-Key: msg_12345</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="180.5908" x="40.0874" y="575.8115">(SAME key - network retry)</text></g><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#000000" points="551.9219,622.1396,561.9219,626.1396,551.9219,630.1396,555.9219,626.1396" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="275.3325" x2="557.9219" y1="626.1396" y2="626.1396"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="161.7954" x="282.3325" y="605.6108">Check: SELECT message</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="264.5894" x="282.3325" y="621.4102">WHERE idempotencyKey = 'msg_12345'</text></g><g class="message" data-participant-1="DB" data-participant-2="API"><polygon fill="#000000" points="286.3325,651.939,276.3325,655.939,286.3325,659.939,282.3325,655.939" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="280.3325" x2="562.9219" y1="655.939" y2="655.939"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="170.1997" x="292.3325" y="651.2095">Found! (cached response)</text></g><path d="M280,668.939 L280,741.939 L497,741.939 L497,678.939 L487,668.939 L280,668.939" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M487,668.939 L487,678.939 L497,678.939 L487,668.939" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="108.583" x="286" y="687.0088">No processing:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="74.4897" x="286" y="702.8081">&#8226; No AI call</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="72.541" x="286" y="718.6074">&#8226; No billing</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="196.041" x="286" y="734.4067">&#8226; Just return cached response</text><g class="message" data-participant-1="API" data-participant-2="Client"><polygon fill="#000000" points="44.0874,780.7349,34.0874,784.7349,44.0874,788.7349,40.0874,784.7349" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="38.0874" x2="274.3325" y1="784.7349" y2="784.7349"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="128.4766" x="50.0874" y="764.2061">200 OK {response}</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="167.8447" x="50.0874" y="780.0054">(identical to first request)</text></g><path d="M38,797.7349 L38,854.7349 L257,854.7349 L257,807.7349 L247,797.7349 L38,797.7349" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M247,797.7349 L247,807.7349 L257,807.7349 L247,797.7349" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="198.3706" x="44" y="815.8047">Client receives same response</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="151.3408" x="44" y="831.604">Can't tell it was cached</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="172.2056" x="44" y="847.4033">Transparent idempotency!</text><rect fill="none" height="180.1465" rx="7.5" ry="7.5" style="stroke:#000000;stroke-width:1;" width="365.1641" x="183.0815" y="953.1475"/><text fill="#000000" font-family="Verdana" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="70.2461" x="188.0815" y="972.2227">Benefits:</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="349.7773" x="188.0815" y="989.2373">&#9989; Network retries safe (no duplicate processing)</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="348.0479" x="188.0815" y="1006.252">&#9989; No duplicate billing (checked before charging)</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="293.9961" x="188.0815" y="1023.2666">&#9989; Transparent to client (same response)</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="355.1641" x="188.0815" y="1040.2813">&#9989; Concurrent requests handled (via session lock)</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="4.9219" x="188.0815" y="1057.2959">&#160;</text><text fill="#000000" font-family="Verdana" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="132.5215" x="188.0815" y="1074.3105">Implementation:</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="352.8164" x="188.0815" y="1091.3252">&#8226; Unique constraint: (sessionId, idempotencyKey)</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="230.6172" x="188.0815" y="1108.3398">&#8226; Fast lookup via database index</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="226.4473" x="188.0815" y="1125.3545">&#8226; Scoped to session (not global)</text><!--SRC=[jLHDRnCn4BtxLqpBeKb4IYbmYHIavajT2cdL1C6X4dAyinjhlVPYEoaLGkB2l-34J-ENCDwFP5iE826KmpeUpvitxurzuDUO8nIAIyrS9dN1BSzXnKMMMhFHyTWeO-7HR1f-Z7df5K8KOruOZrhSGHyMCY-KJ2J6Z77XwVXOITIU4PQNGXPSUpWykueEWJkWBukvvolk40udzQeCJKOFKYAuicOhOxHLQiJOS0WpQPs7Q_ouGVfsvdZRXU6GiQegz5-66WEukbmiuKcEpl4KtOr-ts_Hxb_WtG1obtvuUlhi-Gl6A2LaJaO36AzHP0DOJ5zFnqke0Mxqk_FfzHJa7eCWO0X7Ev0ZnYOZw3VrvyP34YJSWLUqh144sU0U7n_lunGUSwLe0KNTE0MZFUOrki9eX_VuBaXoRF6CbkT_e5acKtQbs01EJqxWyW8-snh-Iwdp0eNHyLxeoOPi5jpZFyjzepkBipTJo33CZqP_Qsm65hszw_uFAsR1XWFe22xM64FJ9jNIb0zMfciF9Ybd4w3NcvkWVx19wdJGwz7cpwy_oD7WZ227zXihgHGTgZTURKWewcDZDJmenf2q3EN-GdxIXvhJT1Eu0cyWAIVULaRynhg-RL0lw9n0kKK7ZjFLtjMdEDT77ZpIX4aFjtIZAeuKMbgk7Ls-aD_IzQ35Mc4Q_goCzoOlPHgXnaHwLolq_HlCMrRAaa62qD46ucPsMi9scwHskDQJl0hMatuhJC9uYpMtQIkfJPWK4bNhdNijDsV7HekDjPKsfOOErbp7Yk0xMyd11K96Wp8Y8tb3Rn6zQVGoQiyzHVOpy5PBGW2w6SvRUZJ9lawT7iMF7ynajqwQSR9F6PDj2WZrTk-Vr35-gWyjX2c843NJq27XFAJAhBZgbaPK5h1V]--></g></svg>